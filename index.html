<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Housing Offline Manager</title>
  <style>
    :root {
      --bg: #0f1419;
      --panel: #141b2a;
      --panel-2: #182033;
      --border: #243145;
      --text: #e6edf3;
      --muted: #9aa4b2;
      --accent: #58a6ff;
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
      --shadow: rgba(0, 0, 0, 0.2);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.25rem;
      box-shadow: 0 4px 12px var(--shadow);
    }

    .header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .title-wrap h1 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--accent);
    }

    .title-wrap p {
      margin: 0.25rem 0 0 0;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
    }

    label {
      font-size: 0.8rem;
      color: var(--muted);
    }

    select, input, textarea, button {
      font: inherit;
      color: var(--text);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.4rem 0.6rem;
    }

    input[type="number"], input[type="date"] {
      padding-right: 0.25rem;
    }

    textarea {
      width: 100%;
      min-height: 110px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease;
    }

    button:hover {
      border-color: var(--accent);
      background: var(--panel-2);
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #05122b;
      font-weight: 600;
    }

    button.success {
      background: var(--success);
      border-color: var(--success);
      color: #041306;
      font-weight: 600;
    }

    button.warning {
      background: var(--warning);
      border-color: var(--warning);
      color: #2c1c02;
      font-weight: 600;
    }

    button.danger {
      background: var(--danger);
      border-color: var(--danger);
      color: #2a0504;
      font-weight: 600;
    }

    button.ghost {
      background: transparent;
    }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 1rem;
      padding: 1rem 1.25rem 2rem;
    }

    nav {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.75rem;
      height: fit-content;
    }

    nav h2 {
      margin: 0 0 0.5rem 0;
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    nav li + li { margin-top: 0.25rem; }

    nav a {
      display: block;
      padding: 0.5rem 0.6rem;
      border-radius: 6px;
      color: var(--text);
      text-decoration: none;
      font-size: 0.9rem;
    }

    nav a:hover { background: rgba(88, 166, 255, 0.15); }
    nav a.active { background: rgba(88, 166, 255, 0.3); color: var(--accent); font-weight: 600; }

    main {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.25rem;
      min-height: 520px;
    }

    h2 {
      margin-top: 0;
      font-size: 1.1rem;
      color: var(--accent);
    }

    .muted { color: var(--muted); }

    .grid {
      display: grid;
      gap: 1rem;
    }

    .grid.two { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .grid.three { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }

    .card {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.85rem;
    }

    .card h3 {
      margin: 0 0 0.5rem 0;
      font-size: 0.95rem;
    }

    .inline-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .form-row {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .form-row.two { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
    .form-row.three { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th { color: var(--muted); font-weight: 600; }

    tr:last-child td { border-bottom: none; }

    .tag {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .tag.success { background: rgba(63, 185, 80, 0.2); color: var(--success); }
    .tag.warning { background: rgba(210, 153, 34, 0.2); color: var(--warning); }
    .tag.danger { background: rgba(248, 81, 73, 0.2); color: var(--danger); }
    .tag.info { background: rgba(88, 166, 255, 0.2); color: var(--accent); }

    .message {
      padding: 0.5rem 0.6rem;
      border-radius: 6px;
      font-size: 0.85rem;
      border: 1px solid transparent;
      margin-bottom: 0.75rem;
    }

    .message.success { border-color: rgba(63, 185, 80, 0.4); background: rgba(63, 185, 80, 0.1); }
    .message.warning { border-color: rgba(210, 153, 34, 0.4); background: rgba(210, 153, 34, 0.1); }
    .message.error { border-color: rgba(248, 81, 73, 0.4); background: rgba(248, 81, 73, 0.1); }

    .divider {
      border-top: 1px solid var(--border);
      margin: 1rem 0;
    }

    .toast {
      position: fixed;
      right: 1.5rem;
      bottom: 1.5rem;
      background: var(--panel-2);
      border: 1px solid var(--border);
      padding: 0.75rem 1rem;
      border-radius: 8px;
      box-shadow: 0 6px 16px var(--shadow);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      max-width: 320px;
      font-size: 0.85rem;
      pointer-events: none;
    }

    .toast.show { opacity: 1; transform: translateY(0); }

    .readonly {
      opacity: 0.6;
    }

    @media (max-width: 860px) {
      .layout { grid-template-columns: 1fr; }
      nav { position: static; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-row">
      <div class="title-wrap">
        <h1>Teacher Housing Offline Manager</h1>
        <p>Single-file, offline-first. Mock data stored in memory and localStorage.</p>
      </div>
      <div class="controls">
        <div>
          <label for="roleSelect">Role</label><br>
          <select id="roleSelect"></select>
        </div>
        <div>
          <label for="userSelect">User</label><br>
          <select id="userSelect"></select>
        </div>
        <div>
          <label>&nbsp;</label><br>
          <button id="resetData" class="warning">Reset to Mock</button>
        </div>
      </div>
    </div>
  </header>

  <div class="layout">
    <nav>
      <h2>Menu</h2>
      <ul id="menuList"></ul>
    </nav>
    <main id="content"></main>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function () {
      'use strict';

      // Data layer
      var STORAGE_KEY = 'teacher-housing-offline-data-v1';
      var AUDIT_KEY = 'teacher-housing-offline-audit-v1';
      var STATE_KEY = 'teacher-housing-offline-state-v1';

      function pad2(value) {
        return String(value).padStart(2, '0');
      }

      function toISODate(date) {
        return date.getFullYear() + '-' + pad2(date.getMonth() + 1) + '-' + pad2(date.getDate());
      }

      function parseISODate(value) {
        if (!value) return new Date();
        var parts = value.split('-').map(Number);
        return new Date(parts[0], (parts[1] || 1) - 1, parts[2] || 1);
      }

      function toPeriod(date) {
        return date.getFullYear() + '-' + pad2(date.getMonth() + 1);
      }

      function addWorkingDays(startDate, days) {
        var date = parseISODate(startDate);
        var remaining = days;
        while (remaining > 0) {
          date.setDate(date.getDate() + 1);
          var day = date.getDay();
          if (day !== 0 && day !== 6) {
            remaining -= 1;
          }
        }
        return toISODate(date);
      }

      function formatMoney(value) {
        var num = Number(value || 0);
        return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function formatDate(value) {
        if (!value) return '-';
        return value;
      }

      function clone(obj) {
        return JSON.parse(JSON.stringify(obj));
      }

      function buildSeedData() {
        var today = new Date();
        var currentPeriod = toPeriod(today);
        var prevPeriod = toPeriod(new Date(today.getFullYear(), today.getMonth() - 1, 1));
        var prev2Period = toPeriod(new Date(today.getFullYear(), today.getMonth() - 2, 1));
        var billedCurrent = currentPeriod + '-01';
        var billedPrev = prevPeriod + '-01';

        return {
          config: {
            waterRate: 10,
            commonFee: 120,
            meterReadFeeVacant: 9,
            approvalRequired: { water: true, electricity: false },
            paymentWorkingDays: 3
          },
          roles: [
            { id: 'resident', name: 'Resident' },
            { id: 'field', name: 'Field Committee' },
            { id: 'accounting', name: 'Accounting' },
            { id: 'admin', name: 'Admin' },
            { id: 'executive', name: 'Executive' },
            { id: 'applicant', name: 'Applicant' }
          ],
          units: [
            { id: 'unit-1', label: 'A-101', type: 'flat', status: 'occupied', residentId: 'res-1' },
            { id: 'unit-2', label: 'A-102', type: 'flat', status: 'occupied', residentId: 'res-2' },
            { id: 'unit-3', label: 'B-201', type: 'house', status: 'vacant', residentId: null },
            { id: 'unit-4', label: 'B-202', type: 'house', status: 'occupied', residentId: 'res-3' }
          ],
          residents: [
            {
              id: 'res-1',
              name: 'Anan Boon',
              email: 'anan@example.com',
              phone: '0801112222',
              unitId: 'unit-1',
              status: 'active',
              household: [{ name: 'Mali Boon', relation: 'Spouse' }]
            },
            {
              id: 'res-2',
              name: 'Nida K.',
              email: 'nida@example.com',
              phone: '0802223333',
              unitId: 'unit-2',
              status: 'active',
              household: [{ name: 'Kawin K.', relation: 'Child' }]
            },
            {
              id: 'res-3',
              name: 'Somchai Lek',
              email: 'somchai@example.com',
              phone: '0805556666',
              unitId: 'unit-4',
              status: 'active',
              household: []
            }
          ],
          users: [
            { id: 'user-res-1', name: 'Anan Boon', role: 'resident', residentId: 'res-1', status: 'active' },
            { id: 'user-res-2', name: 'Nida K.', role: 'resident', residentId: 'res-2', status: 'active' },
            { id: 'user-res-3', name: 'Somchai Lek', role: 'resident', residentId: 'res-3', status: 'active' },
            { id: 'user-field-1', name: 'Field Staff One', role: 'field', status: 'active' },
            { id: 'user-acc-1', name: 'Accounting One', role: 'accounting', status: 'active' },
            { id: 'user-admin-1', name: 'Admin One', role: 'admin', status: 'active' },
            { id: 'user-exec-1', name: 'Executive One', role: 'executive', status: 'active' },
            { id: 'user-app-1', name: 'Applicant Guest', role: 'applicant', status: 'active' }
          ],
          payments: [
            {
              id: 'pay-1',
              residentId: 'res-1',
              period: currentPeriod,
              billedAt: billedCurrent,
              waterUnits: 15,
              waterAmount: 150,
              electricityAmount: 380,
              commonFee: 120,
              totalDue: 650,
              transactions: [],
              verified: false
            },
            {
              id: 'pay-2',
              residentId: 'res-2',
              period: currentPeriod,
              billedAt: billedCurrent,
              waterUnits: 12,
              waterAmount: 120,
              electricityAmount: 420,
              commonFee: 120,
              totalDue: 660,
              transactions: [],
              verified: false
            },
            {
              id: 'pay-3',
              residentId: 'res-3',
              period: currentPeriod,
              billedAt: billedCurrent,
              waterUnits: 18,
              waterAmount: 180,
              electricityAmount: 360,
              commonFee: 120,
              totalDue: 660,
              transactions: [],
              verified: false
            },
            {
              id: 'pay-4',
              residentId: 'res-1',
              period: prevPeriod,
              billedAt: billedPrev,
              waterUnits: 14,
              waterAmount: 140,
              electricityAmount: 350,
              commonFee: 120,
              totalDue: 610,
              transactions: [
                { id: 'tx-1', amount: 610, payer: 'Anan Boon', submittedAt: billedPrev, slipRef: 'SLIP-001', note: '' }
              ],
              verified: true
            },
            {
              id: 'pay-5',
              residentId: 'res-2',
              period: prevPeriod,
              billedAt: billedPrev,
              waterUnits: 11,
              waterAmount: 110,
              electricityAmount: 390,
              commonFee: 120,
              totalDue: 620,
              transactions: [
                { id: 'tx-2', amount: 500, payer: 'Nida K.', submittedAt: billedPrev, slipRef: 'SLIP-014', note: 'Partial' }
              ],
              verified: false
            },
            {
              id: 'pay-6',
              residentId: 'res-3',
              period: prev2Period,
              billedAt: prev2Period + '-01',
              waterUnits: 16,
              waterAmount: 160,
              electricityAmount: 370,
              commonFee: 120,
              totalDue: 650,
              transactions: [
                { id: 'tx-3', amount: 650, payer: 'Somchai Lek', submittedAt: prev2Period + '-03', slipRef: 'SLIP-112', note: '' }
              ],
              verified: true
            }
          ],
          meterRecords: [
            {
              id: 'meter-1',
              unitId: 'unit-1',
              type: 'water',
              period: prevPeriod,
              previousReading: 120,
              currentReading: 135,
              unitsUsed: 15,
              rate: 10,
              amount: 150,
              recordedAt: prevPeriod + '-05',
              recordedBy: 'user-field-1',
              status: 'recorded'
            },
            {
              id: 'meter-2',
              unitId: 'unit-1',
              type: 'electricity',
              period: prevPeriod,
              amount: 350,
              recordedAt: prevPeriod + '-05',
              recordedBy: 'user-field-1',
              status: 'recorded'
            }
          ],
          requests: [
            {
              id: 'req-1',
              type: 'maintenance',
              residentId: 'res-1',
              unitId: 'unit-1',
              status: 'open',
              createdAt: prevPeriod + '-10',
              detail: 'Water leak near sink',
              priority: 'high',
              assignedTo: 'user-field-1',
              trackingCode: 'REQ-1001'
            },
            {
              id: 'req-2',
              type: 'application',
              applicantName: 'Pailin Dee',
              email: 'pailin@example.com',
              phone: '0807778888',
              desiredUnitType: 'flat',
              status: 'queued',
              queueOrder: 2,
              createdAt: prevPeriod + '-12',
              note: 'Near school preferred',
              trackingCode: 'APP-2001'
            }
          ],
          ledgerEntries: [
            { id: 'led-1', period: prevPeriod, type: 'income', category: 'Common Fee', amount: 360, note: '', date: prevPeriod + '-20', createdBy: 'user-acc-1' },
            { id: 'led-2', period: prevPeriod, type: 'expense', category: 'Waste', amount: 90, note: '', date: prevPeriod + '-21', createdBy: 'user-acc-1' }
          ],
          reconciliations: [],
          rounds: [
            { period: prevPeriod, closed: true, closedAt: prevPeriod + '-28', closedBy: 'user-acc-1' },
            { period: currentPeriod, closed: false, closedAt: null, closedBy: null }
          ],
          roundChecks: []
        };
      }

      function loadData() {
        try {
          var raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            return JSON.parse(raw);
          }
        } catch (err) {}
        return buildSeedData();
      }

      function saveData(data) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (err) {}
      }

      function loadAudit() {
        try {
          var raw = localStorage.getItem(AUDIT_KEY);
          if (raw) {
            return JSON.parse(raw);
          }
        } catch (err) {}
        return [];
      }

      function saveAudit(audit) {
        try {
          localStorage.setItem(AUDIT_KEY, JSON.stringify(audit));
        } catch (err) {}
      }

      function loadState() {
        var fallback = { currentRole: 'resident', currentUserId: 'user-res-1', currentView: 'res-dashboard' };
        try {
          var raw = localStorage.getItem(STATE_KEY);
          if (raw) {
            return JSON.parse(raw);
          }
        } catch (err) {}
        return fallback;
      }

      function saveState(state) {
        try {
          localStorage.setItem(STATE_KEY, JSON.stringify(state));
        } catch (err) {}
      }

      var app = {
        data: loadData(),
        audit: loadAudit(),
        state: loadState()
      };

      // Logic layer
      var rolePermissions = {
        resident: ['dashboard.view', 'payment.submit', 'payment.view.own', 'profile.edit', 'request.create', 'request.view.own', 'request.cancel.own'],
        field: ['meter.water.record', 'meter.electric.record', 'request.update', 'request.view.all', 'status.view'],
        accounting: ['payment.verify', 'payment.view.all', 'ledger.edit', 'bank.reconcile', 'round.close'],
        admin: ['user.manage', 'config.edit', 'unit.manage', 'request.manage', 'data.import', 'data.export', 'audit.view'],
        executive: ['report.view', 'audit.view', 'resident.lookup'],
        applicant: ['application.create', 'application.view.own']
      };

      var roleInheritance = {
        field: ['resident'],
        accounting: ['resident'],
        admin: ['resident'],
        executive: [],
        applicant: []
      };

      function getPermissions(role) {
        var perms = (rolePermissions[role] || []).slice();
        var parents = roleInheritance[role] || [];
        parents.forEach(function (parent) {
          perms = perms.concat(rolePermissions[parent] || []);
        });
        return perms;
      }

      function hasPermission(role, permission) {
        return getPermissions(role).indexOf(permission) !== -1;
      }

      function assertPermission(permission) {
        var role = app.state.currentRole;
        if (!hasPermission(role, permission)) {
          throw new Error('Permission denied for ' + permission);
        }
      }

      function getCurrentUser() {
        return app.data.users.find(function (user) {
          return user.id === app.state.currentUserId;
        }) || null;
      }

      function getCurrentResident() {
        var user = getCurrentUser();
        if (!user || !user.residentId) return null;
        return app.data.residents.find(function (res) {
          return res.id === user.residentId;
        }) || null;
      }

      function getUnitById(unitId) {
        return app.data.units.find(function (unit) { return unit.id === unitId; }) || null;
      }

      function getPayment(residentId, period) {
        return app.data.payments.find(function (payment) {
          return payment.residentId === residentId && payment.period === period;
        }) || null;
      }

      function getLatestMeter(unitId, type) {
        var records = app.data.meterRecords.filter(function (record) {
          return record.unitId === unitId && record.type === type;
        });
        records.sort(function (a, b) {
          return parseISODate(b.recordedAt) - parseISODate(a.recordedAt);
        });
        return records[0] || null;
      }

      function calculateTotals(payment) {
        var totalPaid = 0;
        (payment.transactions || []).forEach(function (tx) {
          totalPaid += Number(tx.amount || 0);
        });
        return totalPaid;
      }

      function computePaymentStatus(payment) {
        var dueDate = payment.dueDate || addWorkingDays(payment.billedAt, app.data.config.paymentWorkingDays);
        var nowDate = new Date();
        var nowISO = toISODate(nowDate);
        var totalPaid = calculateTotals(payment);
        var isLate = nowISO > dueDate && totalPaid < payment.totalDue;
        if (totalPaid >= payment.totalDue && payment.verified) return 'paid';
        if (totalPaid > 0 && !payment.verified) return isLate ? 'late' : 'pending';
        if (totalPaid > 0 && totalPaid < payment.totalDue) return isLate ? 'late' : 'underpaid';
        return isLate ? 'late' : 'unpaid';
      }

      function ensurePaymentForResident(residentId, period) {
        var existing = getPayment(residentId, period);
        if (existing) return existing;
        var unit = getUnitById(app.data.residents.find(function (r) { return r.id === residentId; }).unitId);
        var lastWater = getLatestMeter(unit.id, 'water');
        var lastElectric = getLatestMeter(unit.id, 'electricity');
        var waterAmount = lastWater ? lastWater.amount : 150;
        var electricityAmount = lastElectric ? lastElectric.amount : 360;
        var commonFee = app.data.config.commonFee;
        var totalDue = waterAmount + electricityAmount + commonFee;
        var payment = {
          id: 'pay-' + Date.now(),
          residentId: residentId,
          period: period,
          billedAt: period + '-01',
          waterUnits: lastWater ? lastWater.unitsUsed : 15,
          waterAmount: waterAmount,
          electricityAmount: electricityAmount,
          commonFee: commonFee,
          totalDue: totalDue,
          transactions: [],
          verified: false
        };
        app.data.payments.push(payment);
        return payment;
      }

      function refreshDerivedData() {
        var currentPeriod = toPeriod(new Date());
        var hasCurrentRound = app.data.rounds.some(function (round) { return round.period === currentPeriod; });
        if (!hasCurrentRound) {
          app.data.rounds.push({ period: currentPeriod, closed: false, closedAt: null, closedBy: null });
        }
        app.data.payments.forEach(function (payment) {
          payment.dueDate = addWorkingDays(payment.billedAt, app.data.config.paymentWorkingDays);
          payment.status = computePaymentStatus(payment);
          payment.amountPaid = calculateTotals(payment);
        });
        app.data.requests.forEach(function (req) {
          if (!req.trackingCode) {
            req.trackingCode = req.type === 'application' ? 'APP-' + req.id : 'REQ-' + req.id;
          }
        });
      }

      function logAction(action, details) {
        var user = getCurrentUser();
        var entry = {
          id: 'log-' + Date.now(),
          timestamp: new Date().toISOString(),
          actor: user ? user.name : 'System',
          role: app.state.currentRole,
          action: action,
          details: details || {}
        };
        app.audit.unshift(entry);
        saveAudit(app.audit);
      }

      function saveAll() {
        refreshDerivedData();
        saveData(app.data);
        saveAudit(app.audit);
      }

      // UI layer
      var roleSelect = document.getElementById('roleSelect');
      var userSelect = document.getElementById('userSelect');
      var menuList = document.getElementById('menuList');
      var content = document.getElementById('content');
      var toast = document.getElementById('toast');
      var resetData = document.getElementById('resetData');

      var menus = {
        resident: [
          { id: 'res-dashboard', label: 'Dashboard' },
          { id: 'res-payment', label: 'Submit Payment' },
          { id: 'res-history', label: 'Payment History' },
          { id: 'res-requests', label: 'Maintenance Requests' },
          { id: 'res-profile', label: 'Profile' }
        ],
        field: [
          { id: 'field-water', label: 'Record Water Meter' },
          { id: 'field-electric', label: 'Record Electricity' },
          { id: 'field-status', label: 'Round Status' },
          { id: 'field-requests', label: 'Work Orders' }
        ],
        accounting: [
          { id: 'acc-verify', label: 'Verify Payments' },
          { id: 'acc-ledger', label: 'Ledger' },
          { id: 'acc-reconcile', label: 'Bank Reconciliation' },
          { id: 'acc-round', label: 'Close Round' }
        ],
        admin: [
          { id: 'admin-users', label: 'Users and Roles' },
          { id: 'admin-config', label: 'System Settings' },
          { id: 'admin-units', label: 'Housing Units' },
          { id: 'admin-applications', label: 'Applications and Queue' },
          { id: 'admin-data', label: 'Import and Export' },
          { id: 'admin-audit', label: 'Audit Log' }
        ],
        executive: [
          { id: 'exec-dashboard', label: 'Executive Dashboard' },
          { id: 'exec-reports', label: 'Reports' },
          { id: 'exec-residents', label: 'Resident Lookup' },
          { id: 'exec-audit', label: 'Audit Viewer' }
        ],
        applicant: [
          { id: 'app-apply', label: 'Apply for Housing' },
          { id: 'app-track', label: 'Track Application' },
          { id: 'app-about', label: 'About Housing' }
        ]
      };

      function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(function () {
          toast.classList.remove('show');
        }, 2400);
      }

      function setContent(html) {
        content.innerHTML = html;
      }

      function renderRoleOptions() {
        roleSelect.innerHTML = '';
        app.data.roles.forEach(function (role) {
          var opt = document.createElement('option');
          opt.value = role.id;
          opt.textContent = role.name;
          roleSelect.appendChild(opt);
        });
        roleSelect.value = app.state.currentRole;
      }

      function renderUserOptions() {
        userSelect.innerHTML = '';
        var role = app.state.currentRole;
        var users = app.data.users.filter(function (user) { return user.role === role; });
        users.forEach(function (user) {
          var opt = document.createElement('option');
          opt.value = user.id;
          opt.textContent = user.name + (user.status !== 'active' ? ' (inactive)' : '');
          userSelect.appendChild(opt);
        });
        if (!users.length) {
          var opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No users for role';
          userSelect.appendChild(opt);
        }
        if (!users.some(function (user) { return user.id === app.state.currentUserId; })) {
          app.state.currentUserId = users[0] ? users[0].id : '';
        }
        userSelect.value = app.state.currentUserId;
      }

      function renderMenu() {
        menuList.innerHTML = '';
        var items = menus[app.state.currentRole] || [];
        items.forEach(function (item) {
          var li = document.createElement('li');
          var link = document.createElement('a');
          link.href = '#';
          link.textContent = item.label;
          link.dataset.view = item.id;
          if (item.id === app.state.currentView) {
            link.classList.add('active');
          }
          link.addEventListener('click', function (event) {
            event.preventDefault();
            app.state.currentView = item.id;
            saveState(app.state);
            renderMenu();
            renderView();
          });
          li.appendChild(link);
          menuList.appendChild(li);
        });
      }

      function setViewForRole(role) {
        var items = menus[role] || [];
        app.state.currentView = items[0] ? items[0].id : '';
      }

      function getCurrentPeriod() {
        return toPeriod(new Date());
      }

      function statusTag(status) {
        if (status === 'paid') return '<span class="tag success">PAID</span>';
        if (status === 'pending') return '<span class="tag warning">PENDING</span>';
        if (status === 'underpaid') return '<span class="tag warning">UNDERPAID</span>';
        if (status === 'late') return '<span class="tag danger">LATE</span>';
        return '<span class="tag info">UNPAID</span>';
      }

      function renderResidentDashboard() {
        var resident = getCurrentResident();
        if (!resident) {
          setContent('<h2>Resident Dashboard</h2><p class="muted">No resident selected.</p>');
          return;
        }
        var unit = getUnitById(resident.unitId);
        var currentPeriod = getCurrentPeriod();
        var payment = ensurePaymentForResident(resident.id, currentPeriod);
        refreshDerivedData();
        var message = payment.status === 'late' ? '<div class="message warning">Payment is late. Deadline is 3 working days from billing date.</div>' : '';
        setContent(
          '<h2>Resident Dashboard</h2>' +
          message +
          '<div class="grid two">' +
            '<div class="card"><h3>Resident</h3><p>' + resident.name + '</p><p class="muted">Unit: ' + (unit ? unit.label : '-') + '</p></div>' +
            '<div class="card"><h3>Current Period</h3><p>' + currentPeriod + '</p><p class="muted">Due date: ' + payment.dueDate + '</p></div>' +
            '<div class="card"><h3>Total Due</h3><p>' + formatMoney(payment.totalDue) + '</p><p class="muted">Status: ' + statusTag(payment.status) + '</p></div>' +
            '<div class="card"><h3>Breakdown</h3><p>Water: ' + formatMoney(payment.waterAmount) + '</p><p>Electric: ' + formatMoney(payment.electricityAmount) + '</p><p>Common: ' + formatMoney(payment.commonFee) + '</p></div>' +
          '</div>' +
          '<div class="inline-actions">' +
            '<button class="primary" id="goSubmit">Submit Payment</button>' +
            '<button class="ghost" id="goRequest">New Maintenance Request</button>' +
          '</div>'
        );
        document.getElementById('goSubmit').addEventListener('click', function () {
          app.state.currentView = 'res-payment';
          saveState(app.state);
          renderMenu();
          renderView();
        });
        document.getElementById('goRequest').addEventListener('click', function () {
          app.state.currentView = 'res-requests';
          saveState(app.state);
          renderMenu();
          renderView();
        });
      }

      function renderResidentPayment() {
        var resident = getCurrentResident();
        if (!resident) {
          setContent('<h2>Submit Payment</h2><p class="muted">No resident selected.</p>');
          return;
        }
        var period = getCurrentPeriod();
        var payment = ensurePaymentForResident(resident.id, period);
        refreshDerivedData();
        var alreadySubmitted = payment.transactions && payment.transactions.length > 0;
        var warning = alreadySubmitted ? '<div class="message warning">Payment already submitted in this period. New submissions will add to total paid.</div>' : '';
        var household = resident.household || [];
        var payerOptions = ['<option value="' + resident.name + '">' + resident.name + '</option>'];
        household.forEach(function (member) {
          payerOptions.push('<option value="' + member.name + '">' + member.name + '</option>');
        });

        setContent(
          '<h2>Submit Payment</h2>' +
          warning +
          '<div class="card">' +
            '<p><strong>Period:</strong> ' + period + ' | <strong>Due:</strong> ' + payment.dueDate + '</p>' +
            '<p><strong>Total due:</strong> ' + formatMoney(payment.totalDue) + '</p>' +
            '<div id="paymentMessage"></div>' +
            '<div class="form-row two">' +
              '<div><label>Payer</label><br><select id="payerSelect">' + payerOptions.join('') + '</select></div>' +
              '<div><label>Amount</label><br><input type="number" id="payAmount" min="0" step="0.01" value="' + payment.totalDue + '"></div>' +
            '</div>' +
            '<div class="form-row two">' +
              '<div><label>Payment date</label><br><input type="date" id="payDate" value="' + toISODate(new Date()) + '"></div>' +
              '<div><label>Slip reference (required)</label><br><input type="text" id="slipRef" placeholder="SLIP-XXXX"></div>' +
            '</div>' +
            '<div class="form-row">' +
              '<div><label>Note</label><br><input type="text" id="payNote" placeholder="Optional note"></div>' +
            '</div>' +
            '<div class="inline-actions">' +
              '<button class="primary" id="submitPaymentBtn">Submit</button>' +
              '<button class="ghost" id="viewHistoryBtn">View History</button>' +
            '</div>' +
          '</div>'
        );

        document.getElementById('submitPaymentBtn').addEventListener('click', function () {
          var message = document.getElementById('paymentMessage');
          message.innerHTML = '';
          try {
            assertPermission('payment.submit');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var amount = Number(document.getElementById('payAmount').value || 0);
          var slipRef = document.getElementById('slipRef').value.trim();
          var payer = document.getElementById('payerSelect').value;
          var payDate = document.getElementById('payDate').value;
          var note = document.getElementById('payNote').value.trim();
          if (!slipRef) {
            message.innerHTML = '<div class="message error">Slip reference is required.</div>';
            return;
          }
          if (amount <= 0) {
            message.innerHTML = '<div class="message error">Amount must be greater than 0.</div>';
            return;
          }
          payment.transactions.push({
            id: 'tx-' + Date.now(),
            amount: amount,
            payer: payer,
            submittedAt: payDate,
            slipRef: slipRef,
            note: note
          });
          logAction('payment.submit', { paymentId: payment.id, amount: amount });
          saveAll();
          message.innerHTML = '<div class="message success">Payment submitted. Status is now pending verification.</div>';
          showToast('Payment submitted.');
        });

        document.getElementById('viewHistoryBtn').addEventListener('click', function () {
          app.state.currentView = 'res-history';
          saveState(app.state);
          renderMenu();
          renderView();
        });
      }

      function renderResidentHistory() {
        var resident = getCurrentResident();
        if (!resident) {
          setContent('<h2>Payment History</h2><p class="muted">No resident selected.</p>');
          return;
        }
        var payments = app.data.payments.filter(function (payment) { return payment.residentId === resident.id; });
        payments.sort(function (a, b) { return a.period < b.period ? 1 : -1; });
        var rows = payments.map(function (payment) {
          return '<tr>' +
            '<td>' + payment.period + '</td>' +
            '<td>' + formatMoney(payment.totalDue) + '</td>' +
            '<td>' + formatMoney(payment.amountPaid) + '</td>' +
            '<td>' + formatDate(payment.dueDate) + '</td>' +
            '<td>' + statusTag(payment.status) + '</td>' +
            '<td><button class="ghost" data-detail="' + payment.id + '">Details</button></td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Payment History</h2>' +
          '<div class="form-row two">' +
            '<div><label>Status filter</label><br><select id="historyStatus">' +
              '<option value="all">All</option>' +
              '<option value="paid">Paid</option>' +
              '<option value="pending">Pending</option>' +
              '<option value="underpaid">Underpaid</option>' +
              '<option value="late">Late</option>' +
              '<option value="unpaid">Unpaid</option>' +
            '</select></div>' +
            '<div><label>Period contains</label><br><input type="text" id="historyPeriod" placeholder="YYYY-MM"></div>' +
          '</div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Period</th><th>Total Due</th><th>Paid</th><th>Due Date</th><th>Status</th><th></th></tr></thead>' +
            '<tbody id="historyBody">' + rows + '</tbody>' +
          '</table></div>' +
          '<div id="historyDetails" class="card" style="margin-top:1rem; display:none;"></div>'
        );

        function filterHistory() {
          var status = document.getElementById('historyStatus').value;
          var periodText = document.getElementById('historyPeriod').value.trim();
          var filtered = payments.filter(function (payment) {
            var statusOk = status === 'all' || payment.status === status;
            var periodOk = !periodText || payment.period.indexOf(periodText) !== -1;
            return statusOk && periodOk;
          });
          var body = filtered.map(function (payment) {
            return '<tr>' +
              '<td>' + payment.period + '</td>' +
              '<td>' + formatMoney(payment.totalDue) + '</td>' +
              '<td>' + formatMoney(payment.amountPaid) + '</td>' +
              '<td>' + formatDate(payment.dueDate) + '</td>' +
              '<td>' + statusTag(payment.status) + '</td>' +
              '<td><button class="ghost" data-detail="' + payment.id + '">Details</button></td>' +
            '</tr>';
          }).join('');
          document.getElementById('historyBody').innerHTML = body;
        }

        document.getElementById('historyStatus').addEventListener('change', filterHistory);
        document.getElementById('historyPeriod').addEventListener('input', filterHistory);

        content.addEventListener('click', function (event) {
          if (!event.target.dataset.detail) return;
          var paymentId = event.target.dataset.detail;
          var payment = payments.find(function (p) { return p.id === paymentId; });
          if (!payment) return;
          var details = payment.transactions.map(function (tx) {
            return '<li>' + formatDate(tx.submittedAt) + ' | ' + tx.payer + ' | ' + formatMoney(tx.amount) + ' | ' + tx.slipRef + '</li>';
          }).join('');
          var container = document.getElementById('historyDetails');
          container.style.display = 'block';
          container.innerHTML = '<h3>Payment Details</h3>' +
            '<p><strong>Period:</strong> ' + payment.period + '</p>' +
            '<ul>' + (details || '<li>No transactions</li>') + '</ul>';
        });
      }

      function renderResidentRequests() {
        var resident = getCurrentResident();
        if (!resident) {
          setContent('<h2>Maintenance Requests</h2><p class="muted">No resident selected.</p>');
          return;
        }
        var requests = app.data.requests.filter(function (req) { return req.type === 'maintenance' && req.residentId === resident.id; });
        var rows = requests.map(function (req) {
          return '<tr>' +
            '<td>' + req.trackingCode + '</td>' +
            '<td>' + req.detail + '</td>' +
            '<td>' + req.priority + '</td>' +
            '<td>' + req.status + '</td>' +
            '<td><button class="ghost" data-cancel="' + req.id + '">Cancel</button></td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Maintenance Requests</h2>' +
          '<div id="requestMessage"></div>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>Priority</label><br><select id="reqPriority">' +
                '<option value="low">Low</option>' +
                '<option value="medium">Medium</option>' +
                '<option value="high">High</option>' +
              '</select></div>' +
              '<div><label>Request detail</label><br><input type="text" id="reqDetail" placeholder="Describe the issue"></div>' +
            '</div>' +
            '<button class="primary" id="reqSubmit">Create Request</button>' +
          '</div>' +
          '<div class="divider"></div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Tracking</th><th>Detail</th><th>Priority</th><th>Status</th><th></th></tr></thead>' +
            '<tbody>' + (rows || '<tr><td colspan="5" class="muted">No requests yet.</td></tr>') + '</tbody>' +
          '</table></div>'
        );

        document.getElementById('reqSubmit').addEventListener('click', function () {
          var message = document.getElementById('requestMessage');
          message.innerHTML = '';
          try {
            assertPermission('request.create');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var detail = document.getElementById('reqDetail').value.trim();
          var priority = document.getElementById('reqPriority').value;
          if (!detail) {
            message.innerHTML = '<div class="message error">Detail is required.</div>';
            return;
          }
          var tracking = 'REQ-' + Math.floor(1000 + Math.random() * 9000);
          app.data.requests.push({
            id: 'req-' + Date.now(),
            type: 'maintenance',
            residentId: resident.id,
            unitId: resident.unitId,
            status: 'open',
            createdAt: toISODate(new Date()),
            detail: detail,
            priority: priority,
            assignedTo: null,
            trackingCode: tracking
          });
          logAction('request.create', { tracking: tracking });
          saveAll();
          showToast('Request created.');
          renderView();
        });

        content.addEventListener('click', function (event) {
          if (!event.target.dataset.cancel) return;
          var requestId = event.target.dataset.cancel;
          var req = app.data.requests.find(function (r) { return r.id === requestId; });
          if (!req) return;
          try {
            assertPermission('request.cancel.own');
          } catch (err) {
            showToast(err.message);
            return;
          }
          req.status = 'cancelled';
          logAction('request.cancel', { requestId: req.id });
          saveAll();
          showToast('Request cancelled.');
          renderView();
        });
      }

      function renderResidentProfile() {
        var resident = getCurrentResident();
        if (!resident) {
          setContent('<h2>Profile</h2><p class="muted">No resident selected.</p>');
          return;
        }
        var unit = getUnitById(resident.unitId);
        var householdRows = (resident.household || []).map(function (member, index) {
          return '<tr>' +
            '<td>' + member.name + '</td>' +
            '<td>' + member.relation + '</td>' +
            '<td><button class="ghost" data-remove-house="' + index + '">Remove</button></td>' +
          '</tr>';
        }).join('');

        setContent(
          '<h2>Profile</h2>' +
          '<div id="profileMessage"></div>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>Name</label><br><input type="text" id="profileName" value="' + resident.name + '"></div>' +
              '<div><label>Email</label><br><input type="text" id="profileEmail" value="' + resident.email + '"></div>' +
            '</div>' +
            '<div class="form-row two">' +
              '<div><label>Phone</label><br><input type="text" id="profilePhone" value="' + resident.phone + '"></div>' +
              '<div><label>Unit (read-only)</label><br><input type="text" value="' + (unit ? unit.label : '-') + '" disabled></div>' +
            '</div>' +
            '<button class="primary" id="saveProfile">Save Profile</button>' +
          '</div>' +
          '<div class="divider"></div>' +
          '<div class="card">' +
            '<h3>Household Members</h3>' +
            '<div class="form-row two">' +
              '<div><label>Name</label><br><input type="text" id="houseName"></div>' +
              '<div><label>Relation</label><br><input type="text" id="houseRelation"></div>' +
            '</div>' +
            '<button class="ghost" id="addHousehold">Add Member</button>' +
            '<div class="table-wrap" style="margin-top:0.75rem;"><table>' +
              '<thead><tr><th>Name</th><th>Relation</th><th></th></tr></thead>' +
              '<tbody>' + (householdRows || '<tr><td colspan="3" class="muted">No household members.</td></tr>') + '</tbody>' +
            '</table></div>' +
          '</div>'
        );

        document.getElementById('saveProfile').addEventListener('click', function () {
          var message = document.getElementById('profileMessage');
          message.innerHTML = '';
          try {
            assertPermission('profile.edit');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var name = document.getElementById('profileName').value.trim();
          var email = document.getElementById('profileEmail').value.trim();
          var phone = document.getElementById('profilePhone').value.trim();
          if (!name || !email || !phone) {
            message.innerHTML = '<div class="message error">All fields are required.</div>';
            return;
          }
          if (email.indexOf('@') === -1) {
            message.innerHTML = '<div class="message error">Email must contain "@".</div>';
            return;
          }
          resident.name = name;
          resident.email = email;
          resident.phone = phone;
          var user = getCurrentUser();
          if (user) user.name = name;
          logAction('profile.update', { residentId: resident.id });
          saveAll();
          showToast('Profile updated.');
          renderView();
        });

        document.getElementById('addHousehold').addEventListener('click', function () {
          var message = document.getElementById('profileMessage');
          message.innerHTML = '';
          try {
            assertPermission('profile.edit');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var name = document.getElementById('houseName').value.trim();
          var relation = document.getElementById('houseRelation').value.trim();
          if (!name || !relation) {
            message.innerHTML = '<div class="message error">Name and relation are required.</div>';
            return;
          }
          resident.household.push({ name: name, relation: relation });
          logAction('household.add', { residentId: resident.id, name: name });
          saveAll();
          showToast('Household member added.');
          renderView();
        });

        content.addEventListener('click', function (event) {
          if (!event.target.dataset.removeHouse) return;
          var index = Number(event.target.dataset.removeHouse);
          resident.household.splice(index, 1);
          logAction('household.remove', { residentId: resident.id });
          saveAll();
          showToast('Household member removed.');
          renderView();
        });
      }

      function renderFieldWater() {
        var canEdit = hasPermission(app.state.currentRole, 'meter.water.record');
        var unitOptions = app.data.units.map(function (unit) {
          return '<option value="' + unit.id + '">' + unit.label + '</option>';
        }).join('');
        setContent(
          '<h2>Record Water Meter</h2>' +
          '<div id="waterMessage"></div>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>Unit</label><br><select id="waterUnit">' + unitOptions + '</select></div>' +
              '<div><label>Record date</label><br><input type="date" id="waterDate" value="' + toISODate(new Date()) + '"' + (canEdit ? '' : ' disabled') + '></div>' +
            '</div>' +
            '<div class="form-row two">' +
              '<div><label>Previous reading</label><br><input type="number" id="waterPrev" disabled></div>' +
              '<div><label>Current reading</label><br><input type="number" id="waterCurrent" min="0" step="1"' + (canEdit ? '' : ' disabled') + '></div>' +
            '</div>' +
            '<div class="form-row two">' +
              '<div><label>Units used</label><br><input type="number" id="waterUnits" disabled></div>' +
              '<div><label>Amount</label><br><input type="number" id="waterAmount" disabled></div>' +
            '</div>' +
            '<div class="form-row">' +
              '<div><label>Note</label><br><input type="text" id="waterNote"' + (canEdit ? '' : ' disabled') + '></div>' +
            '</div>' +
            '<button class="primary" id="saveWater"' + (canEdit ? '' : ' disabled') + '>Save Record</button>' +
          '</div>'
        );

        function updateWaterView() {
          var unitId = document.getElementById('waterUnit').value;
          var latest = getLatestMeter(unitId, 'water');
          document.getElementById('waterPrev').value = latest ? latest.currentReading : 0;
          document.getElementById('waterCurrent').value = latest ? latest.currentReading : 0;
          document.getElementById('waterUnits').value = 0;
          document.getElementById('waterAmount').value = 0;
        }

        updateWaterView();
        document.getElementById('waterUnit').addEventListener('change', updateWaterView);
        document.getElementById('waterCurrent').addEventListener('input', function () {
          var prev = Number(document.getElementById('waterPrev').value || 0);
          var current = Number(document.getElementById('waterCurrent').value || 0);
          var units = current - prev;
          var amount = units * app.data.config.waterRate;
          document.getElementById('waterUnits').value = units;
          document.getElementById('waterAmount').value = amount >= 0 ? amount : 0;
        });

        document.getElementById('saveWater').addEventListener('click', function () {
          var message = document.getElementById('waterMessage');
          message.innerHTML = '';
          try {
            assertPermission('meter.water.record');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var unitId = document.getElementById('waterUnit').value;
          var prev = Number(document.getElementById('waterPrev').value || 0);
          var current = Number(document.getElementById('waterCurrent').value || 0);
          if (current < prev) {
            message.innerHTML = '<div class="message error">Current reading must be greater than previous.</div>';
            return;
          }
          var units = current - prev;
          var amount = units * app.data.config.waterRate;
          var period = getCurrentPeriod();
          var record = {
            id: 'meter-' + Date.now(),
            unitId: unitId,
            type: 'water',
            period: period,
            previousReading: prev,
            currentReading: current,
            unitsUsed: units,
            rate: app.data.config.waterRate,
            amount: amount,
            recordedAt: document.getElementById('waterDate').value,
            recordedBy: app.state.currentUserId,
            status: app.data.config.approvalRequired.water ? 'pending' : 'recorded',
            note: document.getElementById('waterNote').value.trim()
          };
          app.data.meterRecords.push(record);
          applyMeterToPayment(unitId, 'water', amount, units);
          logAction('meter.water.record', { unitId: unitId, amount: amount });
          saveAll();
          showToast('Water meter recorded.');
          renderView();
        });
      }

      function applyMeterToPayment(unitId, type, amount, units) {
        var unit = getUnitById(unitId);
        if (!unit || !unit.residentId) return;
        var payment = ensurePaymentForResident(unit.residentId, getCurrentPeriod());
        if (type === 'water') {
          payment.waterAmount = amount;
          payment.waterUnits = units;
        } else {
          payment.electricityAmount = amount;
        }
        payment.totalDue = payment.waterAmount + payment.electricityAmount + payment.commonFee;
      }

      function renderFieldElectric() {
        var canEdit = hasPermission(app.state.currentRole, 'meter.electric.record');
        var unitRows = app.data.units.map(function (unit) {
          var latest = getLatestMeter(unit.id, 'electricity');
          var prevAmount = latest ? latest.amount : 0;
          return '<tr>' +
            '<td>' + unit.label + '</td>' +
            '<td>' + formatMoney(prevAmount) + '</td>' +
            '<td><input type="number" data-unit="' + unit.id + '" min="0" step="0.01" value="' + prevAmount + '"' + (canEdit ? '' : ' disabled') + '></td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Record Electricity</h2>' +
          '<div id="electricMessage"></div>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>Period</label><br><input type="text" value="' + getCurrentPeriod() + '" disabled></div>' +
              '<div><label>Total utility bill</label><br><input type="number" id="totalBill" min="0" step="0.01" value="0"' + (canEdit ? '' : ' disabled') + '></div>' +
            '</div>' +
            '<div class="table-wrap"><table>' +
              '<thead><tr><th>Unit</th><th>Previous</th><th>Amount</th></tr></thead>' +
              '<tbody>' + unitRows + '</tbody>' +
            '</table></div>' +
            '<div class="inline-actions">' +
              '<button class="primary" id="saveElectric"' + (canEdit ? '' : ' disabled') + '>Save Electricity</button>' +
            '</div>' +
          '</div>'
        );

        document.getElementById('saveElectric').addEventListener('click', function () {
          var message = document.getElementById('electricMessage');
          message.innerHTML = '';
          try {
            assertPermission('meter.electric.record');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var inputs = content.querySelectorAll('input[data-unit]');
          var total = 0;
          inputs.forEach(function (input) {
            var val = Number(input.value || 0);
            if (val < 0) return;
            total += val;
          });
          var bill = Number(document.getElementById('totalBill').value || 0);
          if (bill && Math.abs(total - bill) > 0.01) {
            message.innerHTML = '<div class="message warning">Sum of unit amounts does not match total bill. Saving is allowed.</div>';
          }
          inputs.forEach(function (input) {
            var amount = Number(input.value || 0);
            var unitId = input.dataset.unit;
            var record = {
              id: 'meter-' + Date.now() + '-' + unitId,
              unitId: unitId,
              type: 'electricity',
              period: getCurrentPeriod(),
              amount: amount,
              recordedAt: toISODate(new Date()),
              recordedBy: app.state.currentUserId,
              status: app.data.config.approvalRequired.electricity ? 'pending' : 'recorded'
            };
            app.data.meterRecords.push(record);
            applyMeterToPayment(unitId, 'electricity', amount, 0);
          });
          logAction('meter.electric.record', { total: total, bill: bill });
          saveAll();
          showToast('Electricity records saved.');
        });
      }

      function renderFieldStatus() {
        var period = getCurrentPeriod();
        var rows = app.data.units.map(function (unit) {
          var water = app.data.meterRecords.some(function (r) { return r.unitId === unit.id && r.type === 'water' && r.period === period; });
          var electric = app.data.meterRecords.some(function (r) { return r.unitId === unit.id && r.type === 'electricity' && r.period === period; });
          var check = app.data.roundChecks.find(function (c) { return c.unitId === unit.id && c.period === period; });
          return '<tr>' +
            '<td>' + unit.label + '</td>' +
            '<td>' + (water ? 'Yes' : 'No') + '</td>' +
            '<td>' + (electric ? 'Yes' : 'No') + '</td>' +
            '<td>' + (check ? 'Reviewed' : 'Pending') + '</td>' +
            '<td><button class="ghost" data-review="' + unit.id + '">Mark Reviewed</button></td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Round Status</h2>' +
          '<p class="muted">Track completion for the current period.</p>' +
          '<div id="statusMessage"></div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Unit</th><th>Water Recorded</th><th>Electric Recorded</th><th>Review</th><th></th></tr></thead>' +
            '<tbody>' + rows + '</tbody>' +
          '</table></div>'
        );

        content.addEventListener('click', function (event) {
          if (!event.target.dataset.review) return;
          var unitId = event.target.dataset.review;
          var existing = app.data.roundChecks.find(function (check) { return check.unitId === unitId && check.period === period; });
          if (existing) return;
          app.data.roundChecks.push({
            id: 'check-' + Date.now(),
            unitId: unitId,
            period: period,
            reviewedBy: app.state.currentUserId,
            reviewedAt: toISODate(new Date())
          });
          logAction('round.review', { unitId: unitId, period: period });
          saveAll();
          showToast('Marked as reviewed.');
          renderView();
        });
      }

      function renderFieldRequests() {
        var requests = app.data.requests.filter(function (req) { return req.type === 'maintenance'; });
        var rows = requests.map(function (req) {
          var resident = app.data.residents.find(function (r) { return r.id === req.residentId; });
          return '<tr>' +
            '<td>' + req.trackingCode + '</td>' +
            '<td>' + (resident ? resident.name : '-') + '</td>' +
            '<td>' + req.detail + '</td>' +
            '<td>' + req.status + '</td>' +
            '<td>' +
              '<select data-status="' + req.id + '">' +
                '<option value="open"' + (req.status === 'open' ? ' selected' : '') + '>open</option>' +
                '<option value="in_progress"' + (req.status === 'in_progress' ? ' selected' : '') + '>in_progress</option>' +
                '<option value="done"' + (req.status === 'done' ? ' selected' : '') + '>done</option>' +
              '</select>' +
            '</td>' +
          '</tr>';
        }).join('');

        setContent(
          '<h2>Work Orders</h2>' +
          '<div id="workMessage"></div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Tracking</th><th>Resident</th><th>Detail</th><th>Status</th><th>Update</th></tr></thead>' +
            '<tbody>' + (rows || '<tr><td colspan="5" class="muted">No work orders.</td></tr>') + '</tbody>' +
          '</table></div>'
        );

        content.addEventListener('change', function (event) {
          if (!event.target.dataset.status) return;
          var reqId = event.target.dataset.status;
          var req = app.data.requests.find(function (r) { return r.id === reqId; });
          if (!req) return;
          try {
            assertPermission('request.update');
          } catch (err) {
            showToast(err.message);
            return;
          }
          req.status = event.target.value;
          req.assignedTo = app.state.currentUserId;
          logAction('request.update', { requestId: req.id, status: req.status });
          saveAll();
          showToast('Request updated.');
        });
      }

      function renderAccountingVerify() {
        var payments = app.data.payments.slice();
        payments.sort(function (a, b) { return a.period < b.period ? 1 : -1; });
        var rows = payments.map(function (payment) {
          var resident = app.data.residents.find(function (r) { return r.id === payment.residentId; });
          return '<tr>' +
            '<td>' + payment.period + '</td>' +
            '<td>' + (resident ? resident.name : '-') + '</td>' +
            '<td>' + formatMoney(payment.totalDue) + '</td>' +
            '<td>' + formatMoney(payment.amountPaid) + '</td>' +
            '<td>' + statusTag(payment.status) + '</td>' +
            '<td>' +
              '<button class="success" data-approve="' + payment.id + '">Approve</button> ' +
              '<button class="danger" data-reject="' + payment.id + '">Flag</button>' +
            '</td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Verify Payments</h2>' +
          '<div id="verifyMessage"></div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Period</th><th>Resident</th><th>Total Due</th><th>Paid</th><th>Status</th><th>Action</th></tr></thead>' +
            '<tbody>' + rows + '</tbody>' +
          '</table></div>' +
          '<div class="card" style="margin-top:1rem;">' +
            '<label>Verification note</label><br><input type="text" id="verifyNote" placeholder="Optional note">' +
          '</div>'
        );

        content.addEventListener('click', function (event) {
          var paymentId = event.target.dataset.approve || event.target.dataset.reject;
          if (!paymentId) return;
          var isApprove = !!event.target.dataset.approve;
          var payment = app.data.payments.find(function (p) { return p.id === paymentId; });
          if (!payment) return;
          try {
            assertPermission('payment.verify');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var note = document.getElementById('verifyNote').value.trim();
          payment.verified = isApprove;
          payment.verification = {
            status: isApprove ? 'approved' : 'flagged',
            note: note,
            verifiedAt: toISODate(new Date()),
            verifiedBy: app.state.currentUserId
          };
          logAction('payment.verify', { paymentId: payment.id, approved: isApprove });
          saveAll();
          showToast('Payment updated.');
          renderView();
        });
      }

      function renderAccountingLedger() {
        var period = getCurrentPeriod();
        var round = app.data.rounds.find(function (r) { return r.period === period; });
        var isClosed = round ? round.closed : false;
        var entries = app.data.ledgerEntries.filter(function (entry) { return entry.period === period; });
        var incomeTotal = entries.filter(function (e) { return e.type === 'income'; }).reduce(function (sum, e) { return sum + Number(e.amount || 0); }, 0);
        var expenseTotal = entries.filter(function (e) { return e.type === 'expense'; }).reduce(function (sum, e) { return sum + Number(e.amount || 0); }, 0);
        var rows = entries.map(function (entry) {
          return '<tr>' +
            '<td>' + entry.date + '</td>' +
            '<td>' + entry.type + '</td>' +
            '<td>' + entry.category + '</td>' +
            '<td>' + formatMoney(entry.amount) + '</td>' +
            '<td>' + (entry.note || '-') + '</td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Ledger</h2>' +
          '<div class="grid two">' +
            '<div class="card"><h3>Income</h3><p>' + formatMoney(incomeTotal) + '</p></div>' +
            '<div class="card"><h3>Expense</h3><p>' + formatMoney(expenseTotal) + '</p></div>' +
          '</div>' +
          '<div class="card" style="margin-top:1rem;">' +
            '<div class="form-row three">' +
              '<div><label>Type</label><br><select id="ledgerType"' + (isClosed ? ' disabled' : '') + '>' +
                '<option value="income">income</option>' +
                '<option value="expense">expense</option>' +
              '</select></div>' +
              '<div><label>Category</label><br><input type="text" id="ledgerCategory"' + (isClosed ? ' disabled' : '') + '></div>' +
              '<div><label>Amount</label><br><input type="number" id="ledgerAmount" min="0" step="0.01"' + (isClosed ? ' disabled' : '') + '></div>' +
            '</div>' +
            '<div class="form-row two">' +
              '<div><label>Date</label><br><input type="date" id="ledgerDate" value="' + toISODate(new Date()) + '"' + (isClosed ? ' disabled' : '') + '></div>' +
              '<div><label>Note</label><br><input type="text" id="ledgerNote"' + (isClosed ? ' disabled' : '') + '></div>' +
            '</div>' +
            '<button class="primary" id="addLedger"' + (isClosed ? ' disabled' : '') + '>Add Entry</button>' +
            (isClosed ? '<p class="muted">Round is closed. Ledger is read-only.</p>' : '') +
          '</div>' +
          '<div class="divider"></div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th>Note</th></tr></thead>' +
            '<tbody>' + (rows || '<tr><td colspan="5" class="muted">No entries.</td></tr>') + '</tbody>' +
          '</table></div>'
        );

        var addBtn = document.getElementById('addLedger');
        if (addBtn) {
          addBtn.addEventListener('click', function () {
            try {
              assertPermission('ledger.edit');
            } catch (err) {
              showToast(err.message);
              return;
            }
            var type = document.getElementById('ledgerType').value;
            var category = document.getElementById('ledgerCategory').value.trim();
            var amount = Number(document.getElementById('ledgerAmount').value || 0);
            var date = document.getElementById('ledgerDate').value;
            var note = document.getElementById('ledgerNote').value.trim();
            if (!category || amount <= 0) {
              showToast('Category and amount are required.');
              return;
            }
            app.data.ledgerEntries.push({
              id: 'led-' + Date.now(),
              period: period,
              type: type,
              category: category,
              amount: amount,
              note: note,
              date: date,
              createdBy: app.state.currentUserId
            });
            logAction('ledger.add', { type: type, amount: amount });
            saveAll();
            showToast('Ledger entry added.');
            renderView();
          });
        }
      }

      function renderAccountingReconcile() {
        var period = getCurrentPeriod();
        var entries = app.data.ledgerEntries.filter(function (entry) { return entry.period === period; });
        var balance = entries.reduce(function (sum, entry) {
          var sign = entry.type === 'income' ? 1 : -1;
          return sum + sign * Number(entry.amount || 0);
        }, 0);
        setContent(
          '<h2>Bank Reconciliation</h2>' +
          '<div class="card">' +
            '<p><strong>System balance:</strong> ' + formatMoney(balance) + '</p>' +
            '<div class="form-row two">' +
              '<div><label>Bank balance</label><br><input type="number" id="bankBalance" min="0" step="0.01"></div>' +
              '<div><label>Note</label><br><input type="text" id="bankNote" placeholder="Optional note"></div>' +
            '</div>' +
            '<button class="primary" id="reconcileBtn">Record Reconciliation</button>' +
            '<div id="reconcileMessage"></div>' +
          '</div>'
        );
        document.getElementById('reconcileBtn').addEventListener('click', function () {
          try {
            assertPermission('bank.reconcile');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var bankBalance = Number(document.getElementById('bankBalance').value || 0);
          var note = document.getElementById('bankNote').value.trim();
          var diff = bankBalance - balance;
          app.data.reconciliations.push({
            id: 'rec-' + Date.now(),
            period: period,
            bankBalance: bankBalance,
            systemBalance: balance,
            diff: diff,
            note: note,
            createdBy: app.state.currentUserId,
            createdAt: toISODate(new Date())
          });
          logAction('bank.reconcile', { diff: diff });
          saveAll();
          var message = document.getElementById('reconcileMessage');
          message.innerHTML = diff === 0
            ? '<div class="message success">Balances match.</div>'
            : '<div class="message warning">Balance difference: ' + formatMoney(diff) + '</div>';
          showToast('Reconciliation recorded.');
        });
      }

      function renderAccountingRound() {
        var options = app.data.rounds.map(function (round) {
          return '<option value="' + round.period + '">' + round.period + (round.closed ? ' (closed)' : ' (open)') + '</option>';
        }).join('');
        setContent(
          '<h2>Close Round</h2>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>Period</label><br><select id="roundPeriod">' + options + '</select></div>' +
              '<div><label>Status</label><br><input type="text" id="roundStatus" disabled></div>' +
            '</div>' +
            '<button class="primary" id="toggleRound">Toggle Close</button>' +
          '</div>'
        );

        function updateStatus() {
          var period = document.getElementById('roundPeriod').value;
          var round = app.data.rounds.find(function (r) { return r.period === period; });
          document.getElementById('roundStatus').value = round && round.closed ? 'Closed' : 'Open';
        }
        updateStatus();
        document.getElementById('roundPeriod').addEventListener('change', updateStatus);
        document.getElementById('toggleRound').addEventListener('click', function () {
          try {
            assertPermission('round.close');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var period = document.getElementById('roundPeriod').value;
          var round = app.data.rounds.find(function (r) { return r.period === period; });
          if (!round) return;
          round.closed = !round.closed;
          round.closedAt = round.closed ? toISODate(new Date()) : null;
          round.closedBy = round.closed ? app.state.currentUserId : null;
          logAction('round.toggle', { period: period, closed: round.closed });
          saveAll();
          showToast('Round status updated.');
          updateStatus();
        });
      }

      function renderAdminUsers() {
        var rows = app.data.users.map(function (user) {
          var resident = user.residentId ? app.data.residents.find(function (r) { return r.id === user.residentId; }) : null;
          var roleOptions = app.data.roles.map(function (role) {
            return '<option value="' + role.id + '"' + (role.id === user.role ? ' selected' : '') + '>' + role.name + '</option>';
          }).join('');
          return '<tr>' +
            '<td>' + user.name + '</td>' +
            '<td>' + (resident ? resident.unitId : '-') + '</td>' +
            '<td><select data-role="' + user.id + '">' + roleOptions + '</select></td>' +
            '<td><select data-status="' + user.id + '">' +
              '<option value="active"' + (user.status === 'active' ? ' selected' : '') + '>active</option>' +
              '<option value="inactive"' + (user.status === 'inactive' ? ' selected' : '') + '>inactive</option>' +
            '</select></td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Users and Roles</h2>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>User</th><th>Unit</th><th>Role</th><th>Status</th></tr></thead>' +
            '<tbody>' + rows + '</tbody>' +
          '</table></div>' +
          '<div class="card" style="margin-top:1rem;">' +
            '<h3>Add Staff User</h3>' +
            '<div class="form-row two">' +
              '<div><label>Name</label><br><input type="text" id="newUserName"></div>' +
              '<div><label>Role</label><br><select id="newUserRole">' +
                '<option value="field">Field Committee</option>' +
                '<option value="accounting">Accounting</option>' +
                '<option value="admin">Admin</option>' +
                '<option value="executive">Executive</option>' +
              '</select></div>' +
            '</div>' +
            '<button class="primary" id="addUserBtn">Add User</button>' +
          '</div>'
        );

        content.addEventListener('change', function (event) {
          if (event.target.dataset.role) {
            try {
              assertPermission('user.manage');
            } catch (err) {
              showToast(err.message);
              return;
            }
            var user = app.data.users.find(function (u) { return u.id === event.target.dataset.role; });
            if (!user) return;
            user.role = event.target.value;
            logAction('user.role.update', { userId: user.id, role: user.role });
            saveAll();
            renderUserOptions();
          }
          if (event.target.dataset.status) {
            try {
              assertPermission('user.manage');
            } catch (err) {
              showToast(err.message);
              return;
            }
            var userStatus = app.data.users.find(function (u) { return u.id === event.target.dataset.status; });
            if (!userStatus) return;
            userStatus.status = event.target.value;
            logAction('user.status.update', { userId: userStatus.id, status: userStatus.status });
            saveAll();
          }
        });

        document.getElementById('addUserBtn').addEventListener('click', function () {
          try {
            assertPermission('user.manage');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var name = document.getElementById('newUserName').value.trim();
          var role = document.getElementById('newUserRole').value;
          if (!name) {
            showToast('Name is required.');
            return;
          }
          app.data.users.push({ id: 'user-' + Date.now(), name: name, role: role, status: 'active' });
          logAction('user.add', { name: name, role: role });
          saveAll();
          showToast('User added.');
          renderUserOptions();
          renderView();
        });
      }

      function renderAdminConfig() {
        var cfg = app.data.config;
        setContent(
          '<h2>System Settings</h2>' +
          '<div id="configMessage"></div>' +
          '<div class="card">' +
            '<div class="form-row three">' +
              '<div><label>Water rate</label><br><input type="number" id="cfgWaterRate" min="0" step="0.01" value="' + cfg.waterRate + '"></div>' +
              '<div><label>Common fee</label><br><input type="number" id="cfgCommonFee" min="0" step="0.01" value="' + cfg.commonFee + '"></div>' +
              '<div><label>Payment working days</label><br><input type="number" id="cfgWorkingDays" min="1" step="1" value="' + cfg.paymentWorkingDays + '"></div>' +
            '</div>' +
            '<div class="form-row two">' +
              '<div><label>Approval required (water)</label><br><select id="cfgWaterApproval">' +
                '<option value="true"' + (cfg.approvalRequired.water ? ' selected' : '') + '>true</option>' +
                '<option value="false"' + (!cfg.approvalRequired.water ? ' selected' : '') + '>false</option>' +
              '</select></div>' +
              '<div><label>Approval required (electric)</label><br><select id="cfgElectricApproval">' +
                '<option value="true"' + (cfg.approvalRequired.electricity ? ' selected' : '') + '>true</option>' +
                '<option value="false"' + (!cfg.approvalRequired.electricity ? ' selected' : '') + '>false</option>' +
              '</select></div>' +
            '</div>' +
            '<button class="primary" id="saveConfig">Save Settings</button>' +
          '</div>'
        );

        document.getElementById('saveConfig').addEventListener('click', function () {
          var message = document.getElementById('configMessage');
          message.innerHTML = '';
          try {
            assertPermission('config.edit');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var waterRate = Number(document.getElementById('cfgWaterRate').value || 0);
          var commonFee = Number(document.getElementById('cfgCommonFee').value || 0);
          var workingDays = Number(document.getElementById('cfgWorkingDays').value || 0);
          if (waterRate <= 0 || commonFee < 0 || workingDays <= 0) {
            message.innerHTML = '<div class="message error">Please enter valid numeric values.</div>';
            return;
          }
          cfg.waterRate = waterRate;
          cfg.commonFee = commonFee;
          cfg.paymentWorkingDays = workingDays;
          cfg.approvalRequired.water = document.getElementById('cfgWaterApproval').value === 'true';
          cfg.approvalRequired.electricity = document.getElementById('cfgElectricApproval').value === 'true';
          logAction('config.update', { waterRate: waterRate, commonFee: commonFee, workingDays: workingDays });
          saveAll();
          message.innerHTML = '<div class="message success">Settings saved.</div>';
          showToast('Settings updated.');
        });
      }

      function renderAdminUnits() {
        var residentOptions = app.data.residents.map(function (res) {
          return '<option value="' + res.id + '">' + res.name + '</option>';
        }).join('');
        var rows = app.data.units.map(function (unit) {
          var statusOptions = ['occupied', 'vacant'].map(function (status) {
            return '<option value="' + status + '"' + (status === unit.status ? ' selected' : '') + '>' + status + '</option>';
          }).join('');
          return '<tr>' +
            '<td>' + unit.label + '</td>' +
            '<td><select data-unit-status="' + unit.id + '">' + statusOptions + '</select></td>' +
            '<td><select data-unit-resident="' + unit.id + '">' +
              '<option value="">-- none --</option>' + residentOptions +
            '</select></td>' +
            '<td><button class="ghost" data-unit-save="' + unit.id + '">Save</button></td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Housing Units</h2>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Unit</th><th>Status</th><th>Resident</th><th></th></tr></thead>' +
            '<tbody>' + rows + '</tbody>' +
          '</table></div>'
        );
        content.querySelectorAll('[data-unit-resident]').forEach(function (select) {
          var unit = app.data.units.find(function (u) { return u.id === select.dataset.unitResident; });
          select.value = unit && unit.residentId ? unit.residentId : '';
        });
        content.addEventListener('click', function (event) {
          if (!event.target.dataset.unitSave) return;
          try {
            assertPermission('unit.manage');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var unitId = event.target.dataset.unitSave;
          var unit = app.data.units.find(function (u) { return u.id === unitId; });
          if (!unit) return;
          var statusSelect = content.querySelector('[data-unit-status="' + unitId + '"]');
          var residentSelect = content.querySelector('[data-unit-resident="' + unitId + '"]');
          unit.status = statusSelect.value;
          unit.residentId = residentSelect.value || null;
          app.data.residents.forEach(function (res) {
            if (res.id === unit.residentId) {
              res.unitId = unit.id;
            }
          });
          logAction('unit.update', { unitId: unitId, status: unit.status, residentId: unit.residentId });
          saveAll();
          showToast('Unit updated.');
        });
      }

      function renderAdminApplications() {
        var apps = app.data.requests.filter(function (req) { return req.type === 'application'; });
        var rows = apps.map(function (req) {
          return '<tr>' +
            '<td>' + req.trackingCode + '</td>' +
            '<td>' + req.applicantName + '</td>' +
            '<td>' + req.status + '</td>' +
            '<td><input type="number" data-queue="' + req.id + '" min="1" value="' + (req.queueOrder || '') + '"></td>' +
            '<td>' +
              '<select data-app-status="' + req.id + '">' +
                '<option value="pending"' + (req.status === 'pending' ? ' selected' : '') + '>pending</option>' +
                '<option value="queued"' + (req.status === 'queued' ? ' selected' : '') + '>queued</option>' +
                '<option value="rejected"' + (req.status === 'rejected' ? ' selected' : '') + '>rejected</option>' +
                '<option value="approved"' + (req.status === 'approved' ? ' selected' : '') + '>approved</option>' +
              '</select>' +
            '</td>' +
            '<td><button class="ghost" data-app-save="' + req.id + '">Save</button></td>' +
          '</tr>';
        }).join('');
        setContent(
          '<h2>Applications and Queue</h2>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Tracking</th><th>Name</th><th>Status</th><th>Queue</th><th>Update</th><th></th></tr></thead>' +
            '<tbody>' + (rows || '<tr><td colspan="6" class="muted">No applications.</td></tr>') + '</tbody>' +
          '</table></div>'
        );
        content.addEventListener('click', function (event) {
          if (!event.target.dataset.appSave) return;
          try {
            assertPermission('request.manage');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var reqId = event.target.dataset.appSave;
          var req = apps.find(function (r) { return r.id === reqId; });
          if (!req) return;
          var statusSelect = content.querySelector('[data-app-status="' + reqId + '"]');
          var queueInput = content.querySelector('[data-queue="' + reqId + '"]');
          req.status = statusSelect.value;
          req.queueOrder = Number(queueInput.value || 0) || null;
          if (req.status === 'queued' && !req.queueOrder) {
            var maxQueue = apps.reduce(function (max, item) { return Math.max(max, item.queueOrder || 0); }, 0);
            req.queueOrder = maxQueue + 1;
          }
          logAction('application.update', { requestId: req.id, status: req.status, queueOrder: req.queueOrder });
          saveAll();
          showToast('Application updated.');
          renderView();
        });
      }

      function toCsv(rows) {
        if (!rows.length) return '';
        var headers = Object.keys(rows[0]);
        var lines = [headers.join(',')];
        rows.forEach(function (row) {
          var line = headers.map(function (key) {
            var value = row[key] == null ? '' : String(row[key]);
            if (value.indexOf('"') !== -1) value = value.replace(/"/g, '""');
            if (value.indexOf(',') !== -1 || value.indexOf('\n') !== -1) value = '"' + value + '"';
            return value;
          }).join(',');
          lines.push(line);
        });
        return lines.join('\n');
      }

      function downloadFile(filename, contentText, mimeType) {
        var blob = new Blob([contentText], { type: mimeType });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function renderAdminData() {
        setContent(
          '<h2>Import and Export</h2>' +
          '<div class="card">' +
            '<div class="inline-actions">' +
              '<button class="primary" id="exportJson">Export JSON</button>' +
              '<button class="ghost" id="exportCsv">Export CSV</button>' +
            '</div>' +
          '</div>' +
          '<div class="card" style="margin-top:1rem;">' +
            '<label>Import JSON</label>' +
            '<textarea id="importText" placeholder="Paste JSON here"></textarea>' +
            '<div class="form-row two">' +
              '<div><input type="file" id="importFile" accept="application/json"></div>' +
              '<div><button class="primary" id="importBtn">Import</button></div>' +
            '</div>' +
            '<div id="importMessage"></div>' +
          '</div>'
        );

        document.getElementById('exportJson').addEventListener('click', function () {
          try {
            assertPermission('data.export');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var bundle = { data: app.data, audit: app.audit };
          downloadFile('teacher-housing-data.json', JSON.stringify(bundle, null, 2), 'application/json');
          showToast('JSON exported.');
        });

        document.getElementById('exportCsv').addEventListener('click', function () {
          try {
            assertPermission('data.export');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var residents = app.data.residents.map(function (r) {
            return { id: r.id, name: r.name, email: r.email, phone: r.phone, unitId: r.unitId, status: r.status, household: JSON.stringify(r.household || []) };
          });
          var payments = app.data.payments.map(function (p) {
            return { id: p.id, residentId: p.residentId, period: p.period, billedAt: p.billedAt, totalDue: p.totalDue, amountPaid: p.amountPaid, status: p.status, transactions: JSON.stringify(p.transactions || []) };
          });
          var meters = app.data.meterRecords.map(function (m) {
            return { id: m.id, unitId: m.unitId, type: m.type, period: m.period, amount: m.amount, recordedAt: m.recordedAt, status: m.status };
          });
          var requests = app.data.requests.map(function (r) {
            return { id: r.id, type: r.type, status: r.status, createdAt: r.createdAt, trackingCode: r.trackingCode, detail: r.detail || '', applicantName: r.applicantName || '' };
          });
          var audit = app.audit.map(function (a) {
            return { id: a.id, timestamp: a.timestamp, actor: a.actor, role: a.role, action: a.action, details: JSON.stringify(a.details || {}) };
          });
          downloadFile('residents.csv', toCsv(residents), 'text/csv');
          downloadFile('payments.csv', toCsv(payments), 'text/csv');
          downloadFile('meter-records.csv', toCsv(meters), 'text/csv');
          downloadFile('requests.csv', toCsv(requests), 'text/csv');
          downloadFile('audit.csv', toCsv(audit), 'text/csv');
          showToast('CSV exported.');
        });

        document.getElementById('importFile').addEventListener('change', function (event) {
          var file = event.target.files[0];
          if (!file) return;
          var reader = new FileReader();
          reader.onload = function (e) {
            document.getElementById('importText').value = e.target.result;
          };
          reader.readAsText(file);
        });

        document.getElementById('importBtn').addEventListener('click', function () {
          var message = document.getElementById('importMessage');
          message.innerHTML = '';
          try {
            assertPermission('data.import');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var text = document.getElementById('importText').value.trim();
          if (!text) {
            message.innerHTML = '<div class="message error">Paste JSON first.</div>';
            return;
          }
          try {
            var parsed = JSON.parse(text);
            var payload = parsed.data ? parsed.data : parsed;
            var errors = validateDataShape(payload);
            if (errors.length) {
              message.innerHTML = '<div class="message error">Invalid schema: ' + errors.join(', ') + '</div>';
              return;
            }
            app.data = payload;
            app.audit = parsed.audit || [];
            saveAll();
            saveState(app.state);
            showToast('Data imported.');
            renderMenu();
            renderView();
          } catch (err) {
            message.innerHTML = '<div class="message error">Invalid JSON.</div>';
          }
        });
      }

      function validateDataShape(data) {
        var errors = [];
        if (!data || typeof data !== 'object') return ['payload missing'];
        if (!Array.isArray(data.residents)) errors.push('residents');
        if (!Array.isArray(data.roles)) errors.push('roles');
        if (!Array.isArray(data.users)) errors.push('users');
        if (!Array.isArray(data.payments)) errors.push('payments');
        if (!Array.isArray(data.meterRecords)) errors.push('meterRecords');
        if (!Array.isArray(data.requests)) errors.push('requests');
        if (!Array.isArray(data.units)) errors.push('units');
        if (!data.config || typeof data.config !== 'object') errors.push('config');
        return errors;
      }

      function renderAdminAudit() {
        var roleOptions = ['<option value="all">All roles</option>'].concat(
          app.data.roles.map(function (role) {
            return '<option value="' + role.id + '">' + role.name + '</option>';
          })
        ).join('');
        setContent(
          '<h2>Audit Log</h2>' +
          '<div class="form-row two">' +
            '<div><label>Filter action</label><br><input type="text" id="auditActionFilter" placeholder="e.g. payment"></div>' +
            '<div><label>Role</label><br><select id="auditRoleFilter">' + roleOptions + '</select></div>' +
          '</div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Time</th><th>Actor</th><th>Role</th><th>Action</th><th>Details</th></tr></thead>' +
            '<tbody id="auditBody"></tbody>' +
          '</table></div>'
        );

        function updateAudit() {
          var actionFilter = document.getElementById('auditActionFilter').value.trim().toLowerCase();
          var roleFilter = document.getElementById('auditRoleFilter').value;
          var rows = app.audit.filter(function (entry) {
            var actionMatch = !actionFilter || entry.action.toLowerCase().indexOf(actionFilter) !== -1;
            var roleMatch = roleFilter === 'all' || entry.role === roleFilter;
            return actionMatch && roleMatch;
          }).map(function (entry) {
            return '<tr>' +
              '<td>' + entry.timestamp + '</td>' +
              '<td>' + entry.actor + '</td>' +
              '<td>' + entry.role + '</td>' +
              '<td>' + entry.action + '</td>' +
              '<td>' + JSON.stringify(entry.details || {}) + '</td>' +
            '</tr>';
          }).join('');
          document.getElementById('auditBody').innerHTML = rows || '<tr><td colspan="5" class="muted">No audit entries.</td></tr>';
        }

        document.getElementById('auditActionFilter').addEventListener('input', updateAudit);
        document.getElementById('auditRoleFilter').addEventListener('change', updateAudit);
        updateAudit();
      }

      function renderExecutiveDashboard() {
        var periodOptions = app.data.rounds.map(function (round) {
          return '<option value="' + round.period + '">' + round.period + '</option>';
        }).join('');
        setContent(
          '<h2>Executive Dashboard</h2>' +
          '<div class="form-row two">' +
            '<div><label>Period</label><br><select id="execPeriod">' + periodOptions + '</select></div>' +
            '<div><label>Summary</label><br><input type="text" id="execSummary" disabled></div>' +
          '</div>' +
          '<div id="execCards" class="grid two"></div>'
        );

        function updateDashboard() {
          var period = document.getElementById('execPeriod').value;
          var payments = app.data.payments.filter(function (p) { return p.period === period; });
          var paidCount = payments.filter(function (p) { return p.status === 'paid'; }).length;
          var lateCount = payments.filter(function (p) { return p.status === 'late'; }).length;
          var rate = payments.length ? Math.round((paidCount / payments.length) * 100) : 0;
          var occupied = app.data.units.filter(function (u) { return u.status === 'occupied'; }).length;
          var vacant = app.data.units.filter(function (u) { return u.status === 'vacant'; }).length;
          var ledger = app.data.ledgerEntries.filter(function (entry) { return entry.period === period; });
          var balance = ledger.reduce(function (sum, entry) {
            var sign = entry.type === 'income' ? 1 : -1;
            return sum + sign * Number(entry.amount || 0);
          }, 0);
          document.getElementById('execSummary').value = 'Paid rate ' + rate + '% | Late ' + lateCount;
          document.getElementById('execCards').innerHTML =
            '<div class="card"><h3>Units</h3><p>Occupied: ' + occupied + '</p><p>Vacant: ' + vacant + '</p></div>' +
            '<div class="card"><h3>Payments</h3><p>Paid: ' + paidCount + ' / ' + payments.length + '</p><p>Late: ' + lateCount + '</p></div>' +
            '<div class="card"><h3>Central Fund</h3><p>Balance: ' + formatMoney(balance) + '</p></div>' +
            '<div class="card"><h3>Applications</h3><p>Total: ' + app.data.requests.filter(function (r) { return r.type === "application"; }).length + '</p></div>';
        }

        updateDashboard();
        document.getElementById('execPeriod').addEventListener('change', updateDashboard);
      }

      function renderExecutiveReports() {
        var periodOptions = app.data.rounds.map(function (round) {
          return '<option value="' + round.period + '">' + round.period + '</option>';
        }).join('');
        setContent(
          '<h2>Reports</h2>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>From</label><br><select id="reportFrom">' + periodOptions + '</select></div>' +
              '<div><label>To</label><br><select id="reportTo">' + periodOptions + '</select></div>' +
            '</div>' +
            '<div class="inline-actions">' +
              '<button class="primary" id="generateReport">Generate Report</button>' +
              '<button class="ghost" id="downloadReportJson">Download JSON</button>' +
              '<button class="ghost" id="downloadReportCsv">Download CSV</button>' +
            '</div>' +
            '<div id="reportOutput" class="message" style="margin-top:0.75rem; display:none;"></div>' +
          '</div>'
        );

        function getReportData() {
          var from = document.getElementById('reportFrom').value;
          var to = document.getElementById('reportTo').value;
          var periods = app.data.rounds.map(function (r) { return r.period; }).filter(function (p) {
            return p >= from && p <= to;
          });
          var payments = app.data.payments.filter(function (p) { return periods.indexOf(p.period) !== -1; });
          var totalDue = payments.reduce(function (sum, p) { return sum + p.totalDue; }, 0);
          var totalPaid = payments.reduce(function (sum, p) { return sum + p.amountPaid; }, 0);
          return {
            from: from,
            to: to,
            periods: periods,
            paymentCount: payments.length,
            totalDue: totalDue,
            totalPaid: totalPaid,
            lateCount: payments.filter(function (p) { return p.status === 'late'; }).length
          };
        }

        document.getElementById('generateReport').addEventListener('click', function () {
          var report = getReportData();
          var output = document.getElementById('reportOutput');
          output.style.display = 'block';
          output.className = 'message';
          output.innerHTML = 'Report for ' + report.from + ' to ' + report.to +
            '<br>Total due: ' + formatMoney(report.totalDue) +
            '<br>Total paid: ' + formatMoney(report.totalPaid) +
            '<br>Late payments: ' + report.lateCount;
          logAction('report.generate', report);
          saveAll();
        });

        document.getElementById('downloadReportJson').addEventListener('click', function () {
          var report = getReportData();
          downloadFile('executive-report.json', JSON.stringify(report, null, 2), 'application/json');
        });
        document.getElementById('downloadReportCsv').addEventListener('click', function () {
          var report = getReportData();
          downloadFile('executive-report.csv', toCsv([report]), 'text/csv');
        });
      }

      function renderExecutiveResidents() {
        setContent(
          '<h2>Resident Lookup</h2>' +
          '<div class="form-row two">' +
            '<div><label>Search</label><br><input type="text" id="resSearch" placeholder="Name or unit"></div>' +
            '<div><label>Result count</label><br><input type="text" id="resCount" disabled></div>' +
          '</div>' +
          '<div class="table-wrap"><table>' +
            '<thead><tr><th>Name</th><th>Unit</th><th>Status</th></tr></thead>' +
            '<tbody id="resLookupBody"></tbody>' +
          '</table></div>'
        );

        function updateLookup() {
          var query = document.getElementById('resSearch').value.trim().toLowerCase();
          var results = app.data.residents.filter(function (res) {
            var unit = getUnitById(res.unitId);
            return !query || res.name.toLowerCase().indexOf(query) !== -1 || (unit && unit.label.toLowerCase().indexOf(query) !== -1);
          });
          document.getElementById('resCount').value = results.length + ' result(s)';
          document.getElementById('resLookupBody').innerHTML = results.map(function (res) {
            var unit = getUnitById(res.unitId);
            return '<tr><td>' + res.name + '</td><td>' + (unit ? unit.label : '-') + '</td><td>' + res.status + '</td></tr>';
          }).join('');
          logAction('resident.lookup', { query: query });
          saveAll();
        }

        document.getElementById('resSearch').addEventListener('input', updateLookup);
        updateLookup();
      }

      function renderExecutiveAudit() {
        renderAdminAudit();
      }

      function renderApplicantApply() {
        setContent(
          '<h2>Apply for Housing</h2>' +
          '<div id="applyMessage"></div>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>Name</label><br><input type="text" id="appName"></div>' +
              '<div><label>Email</label><br><input type="text" id="appEmail"></div>' +
            '</div>' +
            '<div class="form-row two">' +
              '<div><label>Phone</label><br><input type="text" id="appPhone"></div>' +
              '<div><label>Desired unit type</label><br><select id="appUnitType">' +
                '<option value="flat">flat</option>' +
                '<option value="house">house</option>' +
              '</select></div>' +
            '</div>' +
            '<div class="form-row">' +
              '<div><label>Note</label><br><input type="text" id="appNote"></div>' +
            '</div>' +
            '<button class="primary" id="submitApp">Submit Application</button>' +
          '</div>'
        );

        document.getElementById('submitApp').addEventListener('click', function () {
          var message = document.getElementById('applyMessage');
          message.innerHTML = '';
          try {
            assertPermission('application.create');
          } catch (err) {
            message.innerHTML = '<div class="message error">' + err.message + '</div>';
            return;
          }
          var name = document.getElementById('appName').value.trim();
          var email = document.getElementById('appEmail').value.trim();
          var phone = document.getElementById('appPhone').value.trim();
          if (!name || !email || email.indexOf('@') === -1) {
            message.innerHTML = '<div class="message error">Name and valid email are required.</div>';
            return;
          }
          var tracking = 'APP-' + Math.floor(1000 + Math.random() * 9000);
          app.data.requests.push({
            id: 'req-' + Date.now(),
            type: 'application',
            applicantName: name,
            email: email,
            phone: phone,
            desiredUnitType: document.getElementById('appUnitType').value,
            status: 'pending',
            createdAt: toISODate(new Date()),
            note: document.getElementById('appNote').value.trim(),
            trackingCode: tracking
          });
          logAction('application.create', { tracking: tracking });
          saveAll();
          message.innerHTML = '<div class="message success">Application submitted. Tracking code: ' + tracking + '</div>';
          showToast('Application submitted.');
        });
      }

      function renderApplicantTrack() {
        setContent(
          '<h2>Track Application</h2>' +
          '<div class="card">' +
            '<div class="form-row two">' +
              '<div><label>Tracking code</label><br><input type="text" id="trackCode" placeholder="APP-XXXX"></div>' +
              '<div><label>Email (optional)</label><br><input type="text" id="trackEmail"></div>' +
            '</div>' +
            '<button class="primary" id="trackBtn">Track</button>' +
            '<div id="trackResult" style="margin-top:0.75rem;"></div>' +
          '</div>'
        );

        document.getElementById('trackBtn').addEventListener('click', function () {
          try {
            assertPermission('application.view.own');
          } catch (err) {
            showToast(err.message);
            return;
          }
          var code = document.getElementById('trackCode').value.trim();
          var email = document.getElementById('trackEmail').value.trim();
          var req = app.data.requests.find(function (r) {
            var matchesCode = r.trackingCode === code;
            var matchesEmail = !email || (r.email && r.email === email);
            return r.type === 'application' && matchesCode && matchesEmail;
          });
          var output = document.getElementById('trackResult');
          if (!req) {
            output.innerHTML = '<div class="message error">No application found.</div>';
            return;
          }
          output.innerHTML = '<div class="message success">Status: ' + req.status + ' | Queue: ' + (req.queueOrder || '-') + '</div>';
          logAction('application.track', { tracking: req.trackingCode });
          saveAll();
        });
      }

      function renderApplicantAbout() {
        setContent(
          '<h2>About Housing</h2>' +
          '<div class="card">' +
            '<p>This offline demo includes mock data for housing management. All data stays in your browser.</p>' +
            '<button class="ghost" id="toggleAbout">Toggle details</button>' +
            '<div id="aboutDetails" style="display:none; margin-top:0.75rem;">' +
              '<ul>' +
                '<li>Units and flats by zone</li>' +
                '<li>Eligibility summary</li>' +
                '<li>Application queue rules</li>' +
              '</ul>' +
            '</div>' +
          '</div>'
        );
        document.getElementById('toggleAbout').addEventListener('click', function () {
          var details = document.getElementById('aboutDetails');
          details.style.display = details.style.display === 'none' ? 'block' : 'none';
        });
      }

      function resetContentEvents() {
        var fresh = content.cloneNode(false);
        content.parentNode.replaceChild(fresh, content);
        content = fresh;
      }

      function renderView() {
        resetContentEvents();
        refreshDerivedData();
        var view = app.state.currentView;
        var handlers = {
          'res-dashboard': renderResidentDashboard,
          'res-payment': renderResidentPayment,
          'res-history': renderResidentHistory,
          'res-requests': renderResidentRequests,
          'res-profile': renderResidentProfile,
          'field-water': renderFieldWater,
          'field-electric': renderFieldElectric,
          'field-status': renderFieldStatus,
          'field-requests': renderFieldRequests,
          'acc-verify': renderAccountingVerify,
          'acc-ledger': renderAccountingLedger,
          'acc-reconcile': renderAccountingReconcile,
          'acc-round': renderAccountingRound,
          'admin-users': renderAdminUsers,
          'admin-config': renderAdminConfig,
          'admin-units': renderAdminUnits,
          'admin-applications': renderAdminApplications,
          'admin-data': renderAdminData,
          'admin-audit': renderAdminAudit,
          'exec-dashboard': renderExecutiveDashboard,
          'exec-reports': renderExecutiveReports,
          'exec-residents': renderExecutiveResidents,
          'exec-audit': renderExecutiveAudit,
          'app-apply': renderApplicantApply,
          'app-track': renderApplicantTrack,
          'app-about': renderApplicantAbout
        };
        var handler = handlers[view];
        if (handler) {
          handler();
        } else {
          setContent('<h2>Welcome</h2><p class="muted">Select a menu item to begin.</p>');
        }
      }

      roleSelect.addEventListener('change', function () {
        app.state.currentRole = roleSelect.value;
        setViewForRole(app.state.currentRole);
        renderUserOptions();
        saveState(app.state);
        renderMenu();
        renderView();
      });

      userSelect.addEventListener('change', function () {
        app.state.currentUserId = userSelect.value;
        saveState(app.state);
        renderView();
      });

      resetData.addEventListener('click', function () {
        app.data = buildSeedData();
        app.audit = [];
        app.state.currentRole = 'resident';
        app.state.currentUserId = 'user-res-1';
        setViewForRole(app.state.currentRole);
        saveAll();
        saveState(app.state);
        showToast('Data reset to mock.');
        renderRoleOptions();
        renderUserOptions();
        renderMenu();
        renderView();
      });

      refreshDerivedData();
      renderRoleOptions();
      renderUserOptions();
      if (!app.state.currentView) {
        setViewForRole(app.state.currentRole);
      }
      renderMenu();
      renderView();
    })();
  </script>
</body>
</html>
