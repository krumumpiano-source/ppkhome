<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>บันทึกมิเตอร์น้ำ - ระบบบ้านพักครู</title>
  <link rel="stylesheet" href="../assets/css/app.css">
  <script src="../assets/js/css-fix.js"></script>
</head>
<body>
  <header><div class="container"><h1>ระบบบริหารจัดการบ้านพักครู</h1></div></header>
  <nav id="main-nav"></nav>
  <main class="main container">
    <div class="card">
      <h2>บันทึกมิเตอร์น้ำ</h2>
      <p class="text-muted">กรอกเลขมิเตอร์ล่าสุดในตาราง แล้วกดบันทึกได้ทีละแถวหรือทั้งหมด</p>
      <div id="alert" class="alert hide"></div>
      <div class="form-group">
        <label>อัตราค่าน้ำต่อหน่วย</label>
        <div id="waterRate" class="text-muted">กำลังโหลด...</div>
      </div>
      <div class="form-group" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button type="button" id="btnSaveAll" class="btn">บันทึกทุกแถว</button>
        <button type="button" id="btnReload" class="btn btn-secondary">โหลดข้อมูลใหม่</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>หน่วย</th>
              <th>เลขครั้งก่อน</th>
              <th>วันที่ครั้งก่อน</th>
              <th>เลขล่าสุด</th>
              <th>หน่วยที่ใช้</th>
              <th>ยอดค่าน้ำ</th>
              <th>หมายเหตุ</th>
              <th>สถานะ</th>
              <th>บันทึก</th>
            </tr>
          </thead>
          <tbody id="waterTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="card" style="margin-top: 20px;">
      <h3>สร้างรายงานเสนอผู้บริหาร</h3>
      <div class="form-group">
        <label>เลือกรอบการเรียกเก็บ</label>
        <select id="reportRoundId" class="form-control">
          <option value="">กำลังโหลด...</option>
        </select>
      </div>
      <button type="button" id="btnGenerateReport" class="btn btn-primary" style="background-color: #007bff; color: white;">สร้างรายงาน</button>
      <div id="reportAlert" class="alert hide" style="margin-top: 10px;"></div>
    </div>
  </main>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/role-guard.js"></script>
  <script src="../assets/js/water-report.js"></script>
  <script>
    if (!Auth.isLoggedIn()) location.href = '../login.html';
    if (Auth.getRole() !== 'committee' && Auth.getRole() !== 'admin' && Auth.getRole() !== 'deputy_admin') location.href = '../resident/dashboard.html';
    document.getElementById('main-nav').innerHTML = RoleGuard.renderNav('committee/water');
    document.getElementById('nav-logout') && document.getElementById('nav-logout').addEventListener('click', function (e) { e.preventDefault(); API.run('logout', { sessionId: Auth.getSessionId() }, function () { Auth.clear(); location.href = '../login.html'; }); });
    var roundId = 'R' + new Date().getFullYear() + ('0' + (new Date().getMonth() + 1)).slice(-2);
    var waterRate = 0;

    function renderWaterTable(units) {
      var tbody = document.getElementById('waterTableBody');
      tbody.innerHTML = '';
      units.forEach(function(unit) {
        var prevReading = unit.prevReading != null ? Number(unit.prevReading) : null;
        var prevDate = unit.prevDate ? formatDate(unit.prevDate) : '-';
        var tr = document.createElement('tr');
        tr.dataset.unitId = unit.unitId;
        tr.dataset.prevReading = prevReading != null ? prevReading : '';
        tr.innerHTML = ''
          + '<td>' + escapeHtml(unit.unitId) + '</td>'
          + '<td>' + (prevReading != null ? formatNumber(prevReading) : '-') + '</td>'
          + '<td>' + escapeHtml(prevDate) + '</td>'
          + '<td><input type="number" class="current-input" step="0.01" style="max-width: 140px;"></td>'
          + '<td class="units-used text-muted">-</td>'
          + '<td class="amount text-muted">-</td>'
          + '<td><input type="text" class="note-input" style="max-width: 200px;"></td>'
          + '<td class="status text-muted">-</td>'
          + '<td><button type="button" class="btn btn-save" style="padding: 0.35rem 0.7rem;">บันทึก</button></td>';
        tbody.appendChild(tr);
        var currentInput = tr.querySelector('.current-input');
        currentInput.addEventListener('input', function () {
          updateRowCalc(tr);
        });
        tr.querySelector('.btn-save').addEventListener('click', function () {
          saveRow(tr);
        });
      });
    }

    function updateRowCalc(tr) {
      var prevRaw = tr.dataset.prevReading;
      var prev = prevRaw === '' ? null : Number(prevRaw);
      var currentInput = tr.querySelector('.current-input');
      var curr = Number(currentInput.value);
      var unitsEl = tr.querySelector('.units-used');
      var amountEl = tr.querySelector('.amount');
      var statusEl = tr.querySelector('.status');
      if (!currentInput.value || isNaN(curr)) {
        unitsEl.textContent = '-';
        amountEl.textContent = '-';
        statusEl.textContent = '-';
        statusEl.className = 'status text-muted';
        return;
      }
      var unitsUsed = prev == null ? curr : (curr - prev);
      if (unitsUsed < 0) {
        unitsEl.textContent = '-';
        amountEl.textContent = '-';
        statusEl.textContent = 'เลขล่าสุดน้อยกว่าเลขครั้งก่อน';
        statusEl.className = 'status text-muted';
        return;
      }
      var amount = unitsUsed * waterRate;
      unitsEl.textContent = formatNumber(unitsUsed);
      amountEl.textContent = formatNumber(amount);
      statusEl.textContent = 'พร้อมบันทึก';
      statusEl.className = 'status text-muted';
    }

    function saveRow(tr, callback) {
      var unitId = tr.dataset.unitId;
      var prevRaw = tr.dataset.prevReading;
      var prev = prevRaw === '' ? null : Number(prevRaw);
      var currentInput = tr.querySelector('.current-input');
      var curr = Number(currentInput.value);
      var statusEl = tr.querySelector('.status');
      if (!currentInput.value || isNaN(curr)) {
        statusEl.textContent = 'กรุณากรอกเลขล่าสุด';
        statusEl.className = 'status text-muted';
        if (callback) callback(false);
        return;
      }
      if (prev != null && curr < prev) {
        statusEl.textContent = 'เลขล่าสุดต้องไม่น้อยกว่าเลขครั้งก่อน';
        statusEl.className = 'status text-muted';
        if (callback) callback(false);
        return;
      }
      statusEl.textContent = 'กำลังบันทึก...';
      statusEl.className = 'status text-muted';
      API.run('submitWaterReading', {
        sessionId: Auth.getSessionId(),
        roundId: roundId,
        unitId: unitId,
        currentReading: currentInput.value,
        note: tr.querySelector('.note-input').value
      }, function (res) {
        statusEl.textContent = res.success ? 'บันทึกแล้ว' : (res.message || 'บันทึกไม่สำเร็จ');
        statusEl.className = res.success ? 'status text-muted' : 'status text-muted';
        if (callback) callback(res.success);
      });
    }

    function saveAllRows() {
      var rows = Array.prototype.slice.call(document.querySelectorAll('#waterTableBody tr'));
      var targets = rows.filter(function (tr) {
        var currentInput = tr.querySelector('.current-input');
        return currentInput && currentInput.value;
      });
      var alertEl = document.getElementById('alert');
      if (targets.length === 0) {
        alertEl.className = 'alert alert-warning';
        alertEl.textContent = 'ยังไม่มีแถวที่กรอกเลขล่าสุด';
        alertEl.classList.remove('hide');
        return;
      }
      var index = 0;
      var successCount = 0;
      var failCount = 0;
      function next() {
        if (index >= targets.length) {
          alertEl.className = failCount === 0 ? 'alert alert-success' : 'alert alert-warning';
          alertEl.textContent = 'บันทึกสำเร็จ ' + successCount + ' แถว' + (failCount > 0 ? (' · ไม่สำเร็จ ' + failCount + ' แถว') : '');
          alertEl.classList.remove('hide');
          return;
        }
        saveRow(targets[index], function (ok) {
          if (ok) successCount++;
          else failCount++;
          index++;
          next();
        });
      }
      next();
    }

    function loadWaterTable() {
      var alertEl = document.getElementById('alert');
      alertEl.classList.add('hide');
      API.run('getWaterTableData', { sessionId: Auth.getSessionId() }, function (res) {
        if (!res.success) {
          alertEl.className = 'alert alert-error';
          alertEl.textContent = res.message || 'ไม่สามารถโหลดข้อมูลได้';
          alertEl.classList.remove('hide');
          return;
        }
        waterRate = Number(res.ratePerUnit) || 0;
        document.getElementById('waterRate').textContent = formatNumber(waterRate) + ' บาท';
        renderWaterTable(res.units || []);
      });
    }

    document.getElementById('btnSaveAll').addEventListener('click', saveAllRows);
    document.getElementById('btnReload').addEventListener('click', loadWaterTable);
    
    // โหลดรายการรอบการเรียกเก็บ
    function loadBillingRounds() {
      API.run('getBillingRounds', { sessionId: Auth.getSessionId() }, function(res) {
        var select = document.getElementById('reportRoundId');
        if (!res.success || !res.rounds || res.rounds.length === 0) {
          select.innerHTML = '<option value="">ไม่มีข้อมูลรอบการเรียกเก็บ</option>';
          return;
        }
        select.innerHTML = '';
        res.rounds.forEach(function(round) {
          var option = document.createElement('option');
          option.value = round.roundId;
          var monthNames = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                           'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
          option.textContent = round.roundId + ' (' + monthNames[round.month - 1] + ' ' + round.year + ')';
          select.appendChild(option);
        });
        // เลือกรอบปัจจุบันเป็นค่าเริ่มต้น
        var currentRoundId = 'R' + new Date().getFullYear() + ('0' + (new Date().getMonth() + 1)).slice(-2);
        if (res.rounds.find(r => r.roundId === currentRoundId)) {
          select.value = currentRoundId;
        } else if (res.rounds.length > 0) {
          select.value = res.rounds[0].roundId;
        }
      });
    }
    
    // สร้างรายงาน
    document.getElementById('btnGenerateReport').addEventListener('click', function() {
      var roundId = document.getElementById('reportRoundId').value;
      if (!roundId) {
        var alertEl = document.getElementById('reportAlert');
        alertEl.className = 'alert alert-error';
        alertEl.textContent = 'กรุณาเลือกรอบการเรียกเก็บ';
        alertEl.classList.remove('hide');
        return;
      }
      
      var btn = this;
      btn.disabled = true;
      btn.textContent = 'กำลังสร้างรายงาน...';
      
      WaterReport.generate(roundId, function(res) {
        btn.disabled = false;
        btn.textContent = 'สร้างรายงาน';
        var alertEl = document.getElementById('reportAlert');
        if (res.success) {
          alertEl.className = 'alert alert-success';
          alertEl.textContent = 'สร้างรายงานเรียบร้อย กรุณาดูในหน้าต่างใหม่';
        } else {
          alertEl.className = 'alert alert-error';
          alertEl.textContent = res.message || 'เกิดข้อผิดพลาดในการสร้างรายงาน';
        }
        alertEl.classList.remove('hide');
      });
    });
    
    // โหลดรายการรอบเมื่อโหลดหน้า
    loadBillingRounds();
    loadWaterTable();
  </script>
</body>
</html>
