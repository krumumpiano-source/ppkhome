<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n-title="nav.register">ลงทะเบียน</title>
  
  <!-- Tailwind CSS - Use inline CSS for offline mode -->
  <link rel="stylesheet" href="assets/css/tailwind-inline.css">
  <script>
    if (window.location.protocol === 'file:' || !navigator.onLine) {
    } else {
      var script = document.createElement('script');
      script.src = 'https://cdn.tailwindcss.com';
      script.onerror = function() {};
      document.head.appendChild(script);
    }
  </script>
  
  <!-- Custom Styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Sarabun', 'Segoe UI', Tahoma, sans-serif; }
  </style>
  
  <!-- Scripts -->
  <script>
    // ตั้งค่า API Base URL (แก้ไขเป็น Render URL ของคุณ)
    window.API_BASE_URL = 'https://your-app.onrender.com';
  </script>
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/mock-data.js"></script>
  <script src="assets/js/i18n-modern.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/ui-components.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo/Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="appName">ระบบบริหารจัดการบ้านพักครู</h1>
      <p class="text-gray-600" data-i18n="nav.register">ลงทะเบียน</p>
    </div>
    
    <!-- Register Card -->
    <div class="bg-white rounded-xl shadow-xl p-8">
      <div class="mb-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-2">สมัครเข้าบ้านพักครู</h2>
        <p class="text-sm text-gray-600">สำหรับผู้ที่ยังไม่ได้เป็นสมาชิกบ้านพักครู กรุณาตั้งรหัสผ่านเพื่อสร้างบัญชีผู้สมัคร</p>
      </div>
      
      <form id="register-form" class="space-y-5">
        <!-- Alert -->
        <div id="alert" class="hidden"></div>
        
        <!-- Full Name -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            ชื่อ–นามสกุล <span class="text-red-500">*</span>
          </label>
          <input 
            type="text" 
            id="fullName" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="กรอกชื่อ-นามสกุล"
          >
        </div>
        
        <!-- Email -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            อีเมล <span class="text-red-500">*</span>
          </label>
          <input 
            type="email" 
            id="email" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="example@domain.com"
            autocomplete="email"
          >
        </div>
        
        <!-- Phone -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            เบอร์โทร
          </label>
          <input 
            type="tel" 
            id="phone" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="08X-XXX-XXXX"
          >
        </div>
        
        <!-- Password -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            รหัสผ่าน <span class="text-red-500">*</span>
          </label>
          <input 
            type="password" 
            id="password" 
            required 
            minlength="8"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="อย่างน้อย 8 ตัวอักษร"
            autocomplete="new-password"
          >
        </div>
        
        <!-- Confirm Password -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            ยืนยันรหัสผ่าน <span class="text-red-500">*</span>
          </label>
          <input 
            type="password" 
            id="confirmPassword" 
            required 
            minlength="8"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="กรอกรหัสผ่านอีกครั้ง"
            autocomplete="new-password"
          >
        </div>
        
        <!-- Submit Button -->
        <button 
          type="submit" 
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          สมัครสมาชิกผู้สมัคร
        </button>
        
        <!-- Login Link -->
        <div class="text-center pt-4 border-t border-gray-200">
          <p class="text-sm text-gray-600">
            มีบัญชีแล้ว?
            <a href="login.html" class="text-blue-600 hover:text-blue-700 font-medium ml-1" data-i18n="nav.login">เข้าสู่ระบบ</a>
          </p>
        </div>
      </form>
    </div>
    
    <!-- Back to Home -->
    <div class="text-center mt-6">
      <a href="index.html" class="text-sm text-gray-600 hover:text-gray-800 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span data-i18n="back">กลับหน้าหลัก</span>
      </a>
    </div>
  </div>
  
  <script>
    function getRoleRedirect(role) {
      if (role === 'admin' || role === 'deputy_admin') return 'admin/users.html';
      if (role === 'committee') return 'committee/task-status.html';
      if (role === 'accounting') return 'accounting/summary.html';
      if (role === 'executive') return 'executive/dashboard.html';
      if (role === 'applicant') return 'applicant/apply.html';
      return 'resident/dashboard.html';
    }
    
    if (Auth.isLoggedIn()) {
      window.location.href = getRoleRedirect(Auth.getRole());
    }
    
    // Handle form submission
    document.getElementById('register-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const fullName = document.getElementById('fullName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const alertEl = document.getElementById('alert');
      
      if (!password || password.length < 8) {
        alertEl.className = 'bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg';
        alertEl.textContent = 'รหัสผ่านต้องไม่น้อยกว่า 8 ตัวอักษร';
        alertEl.classList.remove('hidden');
        return;
      }
      if (password !== confirmPassword) {
        alertEl.className = 'bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg';
        alertEl.textContent = 'รหัสผ่านไม่ตรงกัน';
        alertEl.classList.remove('hidden');
        return;
      }
      
      // Show loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>กำลังส่ง...';
      
      API.run('registerApplicant', {
        fullName: fullName,
        email: email,
        phone: phone,
        password: password
      }, function(res) {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        
        if (res && res.success) {
          alertEl.className = 'bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg';
          alertEl.textContent = res.message || 'ลงทะเบียนสำเร็จ';
          alertEl.classList.remove('hidden');
          
          UI.toast('ลงทะเบียนสำเร็จ', 'success');
          
          if (res.sessionId) {
            Auth.setSession(res);
            setTimeout(() => {
              window.location.href = getRoleRedirect(res.role || 'applicant');
            }, 500);
          } else {
            // Reset form
            document.getElementById('register-form').reset();
          }
        } else {
          alertEl.className = 'bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg';
          alertEl.textContent = (res && res.message) || 'ไม่สามารถลงทะเบียนได้ในขณะนี้';
          alertEl.classList.remove('hidden');
          
          UI.toast(res.message || 'เกิดข้อผิดพลาด', 'warning');
        }
      });
    });
  </script>
</body>
</html>
