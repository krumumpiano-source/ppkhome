<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-i18n-title="auth.login">เข้าสู่ระบบ</title>
  
  <!-- Tailwind CSS - Use inline CSS for offline mode -->
  <link rel="stylesheet" href="assets/css/tailwind-inline.css">
  <script>
    // Try to load Tailwind CDN, fallback to inline CSS if offline
    if (window.location.protocol === 'file:' || !navigator.onLine) {
      // Use inline CSS (already loaded above)
    } else {
      var script = document.createElement('script');
      script.src = 'https://cdn.tailwindcss.com';
      script.onerror = function() {};
      document.head.appendChild(script);
    }
  </script>
  
  <!-- Custom Styles -->
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Sarabun', 'Segoe UI', Tahoma, sans-serif; }
  </style>
  
  <!-- Scripts -->
  <script>
    // ตั้งค่า API Base URL (แก้ไขเป็น Render URL ของคุณ)
    window.API_BASE_URL = 'https://your-app.onrender.com';
  </script>
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/mock-data.js"></script>
  <script src="assets/js/i18n-modern.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/ui-components.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <!-- Logo/Header -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2" data-i18n="appName">ระบบบริหารจัดการบ้านพักครู</h1>
      <p class="text-gray-600" data-i18n="auth.login">เข้าสู่ระบบ</p>
    </div>
    
    <!-- Login Card -->
    <div class="bg-white rounded-xl shadow-xl p-8">
      <form id="login-form" class="space-y-6">
        <!-- Alert -->
        <div id="alert" class="hidden"></div>
        
        <!-- Email -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="auth.email">อีเมล</label>
          <input 
            type="email" 
            id="email" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="example@domain.com"
            autocomplete="email"
          >
        </div>
        
        <!-- Password -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="auth.password">รหัสผ่าน</label>
          <input 
            type="password" 
            id="password" 
            required 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
            placeholder="••••••••"
            autocomplete="current-password"
          >
        </div>
        
        <!-- Forgot Password Link -->
        <div class="flex justify-end">
          <a href="forgot-password.html" class="text-sm text-blue-600 hover:text-blue-700" data-i18n="auth.forgotPassword">ลืมรหัสผ่าน?</a>
        </div>
        
        <!-- Submit Button -->
        <button 
          type="submit" 
          class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          <span data-i18n="auth.login">เข้าสู่ระบบ</span>
        </button>
        
        <!-- Register Link -->
        <div class="text-center pt-4 border-t border-gray-200">
          <p class="text-sm text-gray-600">
            <span data-i18n="messages.noAccount">ยังไม่มีบัญชี?</span>
            <a href="register.html" class="text-blue-600 hover:text-blue-700 font-medium ml-1" data-i18n="nav.register">ลงทะเบียน</a>
          </p>
        </div>
      </form>
    </div>
    
    <!-- Back to Home -->
    <div class="text-center mt-6">
      <a href="index.html" class="text-sm text-gray-600 hover:text-gray-800 inline-flex items-center gap-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        <span data-i18n="back">กลับหน้าหลัก</span>
      </a>
    </div>
  </div>
  
  <script>
    function getRoleRedirect(role) {
      if (role === 'admin' || role === 'deputy_admin') return 'admin/users.html';
      if (role === 'committee') return 'committee/task-status.html';
      if (role === 'accounting') return 'accounting/summary.html';
      if (role === 'executive') return 'executive/dashboard.html';
      if (role === 'applicant') return 'applicant/apply.html';
      return 'resident/dashboard.html';
    }
    
    // Redirect if already logged in
    if (Auth.isLoggedIn()) {
      window.location.href = getRoleRedirect(Auth.getRole());
    }
    
    // Handle form submission
    document.getElementById('login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const alertEl = document.getElementById('alert');
      
      // Show loading
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></span>' + I18N.t('loading');
      
      API.run('login', { email: email, password: password }, function(res) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        if (res.success) {
          Auth.setSession(res);
          UI.toast(I18N.t('auth.loginSuccess'), 'success');
          
          setTimeout(() => {
            if (res.mustChangePassword) {
              window.location.href = 'resident/profile.html?change=1';
            } else {
              window.location.href = getRoleRedirect(res.role);
            }
          }, 500);
        } else {
          alertEl.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg';
          alertEl.textContent = res.message || I18N.t('auth.loginError');
          alertEl.classList.remove('hidden');
        }
      });
    });
  </script>
</body>
</html>
