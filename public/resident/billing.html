<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แจ้งยอด & ส่งสลิป - ระบบบ้านพักครู</title>

  <link rel="stylesheet" href="../../assets/css/tailwind-inline.css" />
  <script>
    if (window.location.protocol !== 'file:' && navigator.onLine) {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.tailwindcss.com';
      document.head.appendChild(link);
    }
  </script>

  <script>
    window.API_BASE_URL = 'https://your-app.onrender.com';
  </script>
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/auth.js"></script>
  <script src="../../assets/js/mock-data.js"></script>
  <script src="../../assets/js/api.js"></script>
  <script src="../../assets/js/role-guard.js"></script>
  <script src="../../assets/js/layout.js"></script>
  <script src="../../assets/js/ui-components.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="app-header"></div>
  <div id="app-nav"></div>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">แจ้งยอด & ส่งสลิปยืนยันการโอน</h1>
      <p class="text-gray-600">ตรวจสอบยอดล่าสุดและส่งหลักฐานการชำระเงิน</p>
    </div>

    <div id="billing-alert" class="hidden mb-6"></div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">สรุปยอดชำระ</h2>
        <div id="billing-summary" class="space-y-3 text-gray-700">
          <div class="flex items-center justify-between text-sm text-gray-500">
            <span>กำลังโหลดข้อมูล...</span>
          </div>
        </div>
        <div id="billing-items" class="mt-6"></div>
      </section>

      <section class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">ส่งสลิปยืนยันการโอน</h2>
        <div id="alert" class="hidden mb-4"></div>
        <form id="payment-form" class="space-y-4 hidden">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงินที่โอน (บาท)</label>
            <input type="number" id="amount" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">แนบสลิป (URL หรือ Base64)</label>
            <input type="text" id="slip" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ลิงก์หรือข้อมูลสลิป" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ (ถ้ามี)</label>
            <input type="text" id="note" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
          <div class="flex items-start gap-2">
            <input type="checkbox" id="pdpa-consent" class="mt-1">
            <label for="pdpa-consent" class="text-sm text-gray-700">ยินยอมให้เก็บและใช้ข้อมูลหลักฐานการชำระเงินตาม PDPA</label>
          </div>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-lg font-medium hover:bg-blue-700">ส่งหลักฐาน</button>
        </form>
        <div id="payment-status-note" class="text-sm text-gray-600"></div>
      </section>
    </div>
  </main>

  <script>
    if (!Auth.requireLogin('../../login.html')) return;
    Layout.init('resident/billing.html');

    var sessionId = Auth.getSessionId();
    var unitId = Auth.getUnitId();
    var currentRoundId = null;

    function setAlert(targetId, message, success) {
      var el = document.getElementById(targetId);
      el.className = success
        ? 'bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg'
        : 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg';
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function statusLabel(status) {
      if (status === 'paid') return 'ชำระแล้ว';
      if (status === 'pending_check') return 'รอตรวจสอบ';
      if (status === 'unpaid') return 'ยังไม่ชำระ';
      return 'ยังไม่เปิดรอบ';
    }

    function renderSummary(res) {
      var summaryEl = document.getElementById('billing-summary');
      var itemsEl = document.getElementById('billing-items');
      if (!res || !res.success) {
        summaryEl.innerHTML = '<p class="text-gray-500">ไม่สามารถโหลดข้อมูลได้</p>';
        return;
      }
      if (res.status === 'not_open' || !res.round) {
        summaryEl.innerHTML = '<p class="text-gray-500">ยังไม่เปิดรอบแจ้งยอด</p>';
        itemsEl.innerHTML = '';
        return;
      }
      currentRoundId = res.round.id || null;
      var billingDate = res.billingDate ? formatDate(res.billingDate) : '-';
      var dueDate = res.dueDate ? formatDate(res.dueDate) : '-';
      summaryEl.innerHTML = ''
        + '<div class="flex justify-between"><span>รอบเดือน</span><span class="font-medium">' + res.round.month + '/' + res.round.year + '</span></div>'
        + '<div class="flex justify-between"><span>วันที่แจ้งยอด</span><span>' + billingDate + '</span></div>'
        + '<div class="flex justify-between"><span>ครบกำหนดชำระ</span><span>' + dueDate + '</span></div>'
        + '<div class="flex justify-between"><span>สถานะ</span><span class="font-medium">' + statusLabel(res.status) + '</span></div>'
        + '<div class="flex justify-between text-lg font-semibold"><span>ยอดรวม</span><span>' + formatNumber(res.total) + ' บาท</span></div>';

      var typeLabel = { water: 'ค่าน้ำ', electric: 'ค่าไฟ', common: 'ค่าส่วนกลาง' };
      var table = '<div class="border-t border-gray-200 pt-4"><h3 class="font-semibold text-gray-900 mb-2">รายละเอียด</h3>';
      table += '<div class="space-y-2 text-sm text-gray-700">';
      res.items.forEach(function(item) {
        table += '<div class="flex justify-between"><span>' + (typeLabel[item.type] || item.type) + '</span><span>' + formatNumber(item.amount) + ' บาท</span></div>';
      });
      table += '</div></div>';
      itemsEl.innerHTML = table;
    }

    function togglePaymentForm(status) {
      var form = document.getElementById('payment-form');
      var note = document.getElementById('payment-status-note');
      if (status === 'paid') {
        form.classList.add('hidden');
        note.textContent = 'ท่านได้ชำระครบถ้วนแล้ว';
      } else if (status === 'pending_check') {
        form.classList.add('hidden');
        note.textContent = 'ระบบได้รับสลิปแล้ว อยู่ระหว่างการตรวจสอบ';
      } else if (status === 'not_open') {
        form.classList.add('hidden');
        note.textContent = 'ยังไม่เปิดรอบแจ้งยอด';
      } else {
        form.classList.remove('hidden');
        note.textContent = '';
      }
    }

    if (!unitId) {
      setAlert('billing-alert', 'ยังไม่มีหน่วยที่พัก ไม่สามารถแสดงยอดชำระได้', false);
    } else {
      var roundIdParam = getQueryParam('roundId');
      API.run('getBillingForUnit', { sessionId: sessionId, unitId: unitId, roundId: roundIdParam }, function(res) {
        if (!res.success) {
          setAlert('billing-alert', res.message || 'ไม่สามารถโหลดข้อมูล', false);
          return;
        }
        renderSummary(res);
        togglePaymentForm(res.status);
        if (!currentRoundId && res.round && res.round.id) currentRoundId = res.round.id;
      });

      document.getElementById('payment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        var consent = document.getElementById('pdpa-consent').checked;
        if (!consent) {
          setAlert('alert', 'กรุณายินยอม PDPA ก่อนส่งหลักฐาน', false);
          return;
        }
        if (!currentRoundId) {
          setAlert('alert', 'ไม่พบรอบการชำระ กรุณาลองใหม่', false);
          return;
        }
        API.run('submitPayment', {
          sessionId: sessionId,
          roundId: currentRoundId,
          unitId: unitId,
          amount: document.getElementById('amount').value,
          slipDataUrl: document.getElementById('slip').value,
          note: document.getElementById('note').value
        }, function(res) {
          setAlert('alert', res.message || (res.success ? 'ส่งหลักฐานเรียบร้อย' : 'ไม่สามารถส่งหลักฐานได้'), res.success);
          if (res.success) {
            setTimeout(function() { location.reload(); }, 1500);
          }
        });
      });
    }
  </script>
</body>
</html>
