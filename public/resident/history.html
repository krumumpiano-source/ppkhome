<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ประวัติการชำระ - ระบบบ้านพักครู</title>
  <link rel="stylesheet" href="../assets/css/app.css">
  <script src="../assets/js/css-fix.js"></script>
</head>
<body>
  <header><div class="container"><h1>ระบบบริหารจัดการบ้านพักครู</h1></div></header>
  <nav id="main-nav"></nav>
  <main class="main container">
    <div class="card">
      <h2>ประวัติการชำระของฉัน</h2>
      <p class="text-muted payment-status-disclaimer">ระบบกำหนดให้ชำระภายใน 3 วันทำการหลังแจ้งยอด<br>ข้อมูลนี้แสดงเฉพาะของท่านเท่านั้น</p>
      <div id="payment-status-list"></div>
      <h3 class="section-sub">รายการชำระเงิน</h3>
      <div id="list"></div>
    </div>
  </main>
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/mock-data.js"></script>
  <script src="../assets/js/api.js"></script>
  <script src="../assets/js/role-guard.js"></script>
  <script>
    if (!Auth.isLoggedIn()) location.href = '../login.html';
    document.getElementById('main-nav').innerHTML = RoleGuard.renderNav('resident/history');
    document.getElementById('nav-logout') && document.getElementById('nav-logout').addEventListener('click', function (e) { e.preventDefault(); API.run('logout', { sessionId: Auth.getSessionId() }, function () { Auth.clear(); location.href = '../login.html'; }); });
    var unitId = Auth.getUnitId();
    if (!unitId) {
      document.getElementById('list').innerHTML = '<p>ยังไม่มีหน่วยที่พัก</p>';
      document.getElementById('payment-status-list').innerHTML = '';
    } else {
      API.run('getMyPaymentStatusList', { sessionId: Auth.getSessionId() }, function (res) {
        var listEl = document.getElementById('payment-status-list');
        if (!res.success || !res.items || !res.items.length) { listEl.innerHTML = '<p class="text-muted">ยังไม่มีข้อมูลสถานะการชำระ</p>'; }
        else {
          var today = new Date();
          today.setHours(0, 0, 0, 0);
          var html = '<table class="payment-status-table"><tr><th>รอบเดือน</th><th>วันที่แจ้งยอด</th><th>ครบกำหนด</th><th>สถานะการชำระ</th><th>วันที่ชำระ</th></tr>';
          res.items.forEach(function (item) {
            var due = item.due_date ? new Date(item.due_date) : null;
            var overdue = due && today > due;
            var label = '';
            if (item.payment_status === 'PAID_ON_TIME') label = '✅ ชำระตรงเวลา';
            else if (item.payment_status === 'PAID_LATE') label = '⏰ ชำระล่าช้า ' + (item.late_days || 0) + ' วัน';
            else label = '❌ ยังไม่ชำระ' + (overdue ? ' (ครบกำหนดแล้ว)' : '');
            html += '<tr><td>' + escapeHtml(item.round_month) + '/' + escapeHtml(item.round_year) + '</td>';
            html += '<td>' + formatDate(item.billing_date) + '</td><td>' + formatDate(item.due_date) + '</td>';
            html += '<td>' + label + '</td><td>' + (item.payment_date ? formatDate(item.payment_date) : '—') + '</td></tr>';
          });
          html += '</table>';
          listEl.innerHTML = html;
        }
      });
      API.run('getPaymentHistory', { sessionId: Auth.getSessionId(), unitId: unitId }, function (res) {
        var el = document.getElementById('list');
        if (!res.success || !res.rows || !res.rows.length) { el.innerHTML = '<p class="text-muted">ยังไม่มีประวัติการโอน/ชำระ</p>'; return; }
        var t = '<table><tr><th>รอบ</th><th>จำนวน (บาท)</th><th>วันที่</th><th>สถานะ</th></tr>';
        res.rows.forEach(function (r) {
          t += '<tr><td>' + escapeHtml(r.roundId) + '</td><td>' + formatNumber(r.amount) + '</td><td>' + formatDate(r.date) + '</td><td>' + (r.verified ? 'ตรวจแล้ว' : 'รอตรวจ') + '</td></tr>';
        });
        t += '</table>';
        el.innerHTML = t;
      });
    }
  </script>
</body>
</html>
