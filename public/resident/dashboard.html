<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>แดชบอร์ด - ระบบบ้านพักครู</title>

  <!-- Tailwind (Offline-first) -->
  <link rel="stylesheet" href="../../assets/css/tailwind-inline.css" />
  <script>
    // Fallback to CDN if inline CSS not available
    if (window.location.protocol !== 'file:' && navigator.onLine) {
      var link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdn.tailwindcss.com';
      document.head.appendChild(link);
    }
  </script>

  <!-- ตั้งค่า API Base URL (แก้ไขเป็น Render URL ของคุณ) -->
  <script>
    window.API_BASE_URL = 'https://your-app.onrender.com';
  </script>
  <!-- Core JS (ห้ามเปลี่ยนลำดับ) -->
  <script src="../../assets/js/utils.js"></script>
  <script src="../../assets/js/auth.js"></script>
  <script src="../../assets/js/mock-data.js"></script>
  <script src="../../assets/js/api.js"></script>
  <script src="../../assets/js/role-guard.js"></script>
  <script src="../../assets/js/layout.js"></script>
  <script src="../../assets/js/ui-components.js"></script>
</head>

<body class="bg-gray-50 text-gray-900">
  <div id="app-header"></div>
  <div id="app-nav"></div>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">แดชบอร์ด</h1>
      <p class="text-gray-600" id="welcome-message"></p>
    </div>
    
    <!-- Billing Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Latest Bill -->
      <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm text-gray-500 mb-1">ยอดชำระล่าสุด</p>
            <p class="text-2xl font-bold text-gray-900" id="latest-bill-amount">-</p>
            <p class="text-xs text-gray-400 mt-1" id="latest-bill-round"></p>
            <p class="text-xs text-gray-400 mt-1" id="latest-bill-due"></p>
          </div>
          <div class="bg-blue-100 rounded-full p-3">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
        <div class="mt-4" id="latest-bill-action"></div>
      </div>

      <!-- Previous Bill -->
      <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-indigo-500">
        <div class="flex items-start justify-between">
          <div>
            <p class="text-sm text-gray-500 mb-1">ยอดชำระก่อนหน้า 1 เดือน</p>
            <p class="text-2xl font-bold text-gray-900" id="previous-bill-amount">-</p>
            <p class="text-xs text-gray-400 mt-1" id="previous-bill-round"></p>
            <p class="text-xs text-gray-400 mt-1" id="previous-bill-due"></p>
          </div>
          <div class="bg-indigo-100 rounded-full p-3">
            <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10m-12 8h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Payment Status -->
      <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 mb-1">สถานะการชำระล่าสุด</p>
            <p class="text-2xl font-bold text-gray-900" id="payment-status-text">-</p>
            <p class="text-xs text-gray-400 mt-1" id="payment-status-detail"></p>
          </div>
          <div class="bg-green-100 rounded-full p-3">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
      </div>

      <!-- Unit Info -->
      <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 mb-1">บ้าน/แฟลต</p>
            <p class="text-2xl font-bold text-gray-900" id="unit-id">-</p>
            <p class="text-xs text-gray-400 mt-1" id="unit-status"></p>
          </div>
          <div class="bg-purple-100 rounded-full p-3">
            <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Payment Status Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">สถานะการชำระ</h2>
      
      <!-- Disclaimer -->
      <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 rounded">
        <p class="text-sm text-gray-700">
          ข้อมูลนี้แสดงเฉพาะสถานะการชำระของท่านเท่านั้น เพื่อความโปร่งใสและตรวจสอบได้ ไม่มีการเปรียบเทียบหรือประเมินผลกับผู้อื่น
        </p>
      </div>
      
      <!-- Payment Status List -->
      <div id="payment-status-list" class="space-y-4">
        <div class="flex items-center justify-center py-8">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <span class="ml-3 text-gray-600">กำลังโหลด...</span>
        </div>
      </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">กิจกรรมล่าสุด</h2>
      <div id="recent-activity" class="space-y-3">
        <div class="text-center py-8 text-gray-500">ไม่มีข้อมูล</div>
      </div>
    </div>
  </main>

  <script>
    if (!Auth.requireLogin('../../login.html')) return;
    Layout.init('resident/dashboard.html');

    var sessionId = Auth.getSessionId();
    var unitId = Auth.getUnitId();
    var latestStatus = null;
    var previousStatus = null;
    var latestBilling = null;
    var previousBilling = null;

    function formatMoney(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) return '-';
      return '฿' + Number(amount).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function setText(id, text) {
      var el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function getStatusLabel(status) {
      if (!status) return '-';
      if (status.payment_status === 'PAID_ON_TIME') return 'ชำระตรงเวลา';
      if (status.payment_status === 'PAID_LATE') return 'ชำระล่าช้า';
      if (status.payment_status === 'UNPAID') return 'ยังไม่ชำระ';
      return '-';
    }

    function getStatusDetail(status) {
      if (!status) return '';
      if (status.payment_status === 'PAID_LATE') return (status.late_days || 0) + ' วัน';
      if (status.payment_status === 'UNPAID') return 'ค้างชำระ';
      return 'ชำระแล้ว';
    }

    function renderBillingCards() {
      if (latestStatus) {
        setText('latest-bill-round', 'รอบเดือน: ' + latestStatus.round_month + '/' + latestStatus.round_year);
        setText('latest-bill-due', 'ครบกำหนด: ' + formatDate(latestStatus.due_date));
      } else {
        setText('latest-bill-round', 'รอบเดือน: -');
        setText('latest-bill-due', '');
      }
      if (previousStatus) {
        setText('previous-bill-round', 'รอบเดือน: ' + previousStatus.round_month + '/' + previousStatus.round_year);
        setText('previous-bill-due', 'ครบกำหนด: ' + formatDate(previousStatus.due_date));
      } else {
        setText('previous-bill-round', 'รอบเดือน: -');
        setText('previous-bill-due', '');
      }

      setText('latest-bill-amount', latestBilling && latestBilling.total !== undefined ? formatMoney(latestBilling.total) : '-');
      setText('previous-bill-amount', previousBilling && previousBilling.total !== undefined ? formatMoney(previousBilling.total) : '-');

      var actionEl = document.getElementById('latest-bill-action');
      if (!actionEl) return;
      if (!latestStatus) {
        actionEl.innerHTML = '<span class="text-xs text-gray-400">ไม่มีข้อมูลรอบล่าสุด</span>';
        return;
      }
      if (!unitId) {
        actionEl.innerHTML = '<span class="text-xs text-gray-400">ยังไม่มีหน่วยที่พัก</span>';
        return;
      }
      var href = 'billing.html?roundId=' + encodeURIComponent(latestStatus.roundId || '');
      if (latestBilling && latestBilling.status === 'paid') {
        actionEl.innerHTML = '<span class="inline-flex items-center px-3 py-1.5 text-xs font-medium bg-gray-200 text-gray-600 rounded-lg">ชำระแล้ว</span>';
      } else if (latestBilling && latestBilling.status === 'pending_check') {
        actionEl.innerHTML = '<span class="inline-flex items-center px-3 py-1.5 text-xs font-medium bg-yellow-100 text-yellow-700 rounded-lg">รอตรวจสอบ</span>';
      } else {
        actionEl.innerHTML = '<a href="' + href + '" class="inline-flex items-center px-3 py-1.5 text-xs font-medium bg-blue-600 text-white rounded-lg hover:bg-blue-700">ส่งสลิปยืนยันการโอน</a>';
      }
    }

    function renderStatusList(statuses) {
      var container = document.getElementById('payment-status-list');
      if (!container) return;
      if (!statuses || statuses.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500">ไม่มีข้อมูล</div>';
        return;
      }
      var html = '';
      statuses.slice(0, 5).forEach(function(status) {
        var icon = '⏰';
        var bgColor = 'bg-gray-100';
        if (status.payment_status === 'PAID_ON_TIME') {
          icon = '✅';
          bgColor = 'bg-green-100';
        } else if (status.payment_status === 'PAID_LATE') {
          icon = '⏰';
          bgColor = 'bg-yellow-100';
        } else if (status.payment_status === 'UNPAID') {
          icon = '❌';
          bgColor = 'bg-red-100';
        }
        html += '<div class="flex items-center justify-between p-4 ' + bgColor + ' rounded-lg">' +
          '<div class="flex items-center gap-3">' +
          '<span class="text-2xl">' + icon + '</span>' +
          '<div>' +
          '<p class="font-medium text-gray-900">รอบ ' + status.round_month + '/' + status.round_year + '</p>' +
          '<p class="text-sm text-gray-600">ครบกำหนด: ' + formatDate(status.due_date) + '</p>' +
          '</div>' +
          '</div>' +
          '<div class="text-right">' +
          '<p class="text-sm font-medium text-gray-900">' + getStatusLabel(status) + '</p>' +
          (status.late_days > 0 ? '<p class="text-xs text-gray-500">' + status.late_days + ' วัน</p>' : '') +
          '</div>' +
          '</div>';
      });
      container.innerHTML = html;
    }

    function loadBillingForStatus(statusItem, setter) {
      if (!statusItem || !unitId) {
        setter(null);
        renderBillingCards();
        return;
      }
      API.run('getBillingForUnit', { sessionId: sessionId, unitId: unitId, roundId: statusItem.roundId }, function(res) {
        if (res && res.success) {
          setter(res);
        } else {
          setter(null);
        }
        renderBillingCards();
      });
    }

    API.run('getMyProfile', { sessionId: sessionId }, function(res) {
      if (res.success && res.profile) {
        var name = res.profile.fullName || res.profile.email || 'ผู้ใช้';
        document.getElementById('welcome-message').textContent = 'ยินดีต้อนรับ, ' + name;
        if (res.profile.unitId) {
          unitId = res.profile.unitId;
          setText('unit-id', res.profile.unitId);
          setText('unit-status', 'ผู้พักอาศัย');
        }
      }
    });

    API.run('getMyPaymentStatusList', { sessionId: sessionId }, function(res) {
      if (res.success && res.items && res.items.length > 0) {
        latestStatus = res.items[0];
        previousStatus = res.items.length > 1 ? res.items[1] : null;
        setText('payment-status-text', getStatusLabel(latestStatus));
        setText('payment-status-detail', getStatusDetail(latestStatus));
        renderStatusList(res.items);
        loadBillingForStatus(latestStatus, function(value) { latestBilling = value; });
        loadBillingForStatus(previousStatus, function(value) { previousBilling = value; });
      } else {
        setText('payment-status-text', '-');
        setText('payment-status-detail', '');
        renderStatusList([]);
        renderBillingCards();
      }
    });

    if (unitId) {
      setText('unit-id', unitId);
      setText('unit-status', 'ผู้พักอาศัย');
    }
  </script>
</body>
</html>
